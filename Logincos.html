<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - CBT Practice</title>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <style>
        :root {
            --background: #f8fafc;
            --foreground: #1f2937;
            --card-bg: #ffffff;
            --card-foreground: #1f2937;
            --primary: #22c55e;
            --primary-foreground: #ffffff;
            --primary-hover: #16a34a;
            --secondary: #f1f5f9;
            --secondary-foreground: #1f2937;
            --border: #e2e8f0;
            --ring: #22c55e;
            --error: #ef4444;
            --success: #22c55e;
        }

        .dark {
            --background: #1f2937;
            --foreground: #f8fafc;
            --card-bg: #374151;
            --card-foreground: #f8fafc;
            --primary: #22c55e;
            --primary-foreground: #ffffff;
            --primary-hover: #16a34a;
            --secondary: #334155;
            --secondary-foreground: #f8fafc;
            --border: #4b5563;
            --ring: #22c55e;
            --error: #ef4444;
            --success: #22c55e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            line-height: 1.5;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .login-bg-pattern {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cg fill='none' stroke='%23d1d5db' stroke-width='1'%3E%3Crect width='40' height='40' x='10' y='10'/%3E%3Ccircle cx='130' cy='30' r='20'/%3E%3Cpath d='M170 100l-20 20 20 20 20-20z'/%3E%3Cpath d='M30 140c0-11 9-20 20-20s20 9 20 20-9 20-20 20-20-9-20-20z'/%E3%83%3Cpath d='M130 180l-10-10 10-10 10 10-10 10'/%E3%83%3C/g%E3%83%3C/svg%E3%83%3E");
        }

        .dark .login-bg-pattern {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cg fill='none' stroke='%23374151' stroke-width='1'%3E%3Crect width='40' height='40' x='10' y='10'/%3E%3Ccircle cx='130' cy='30' r='20'/%E3%83%3Cpath d='M170 100l-20 20 20 20 20-20z'/%E3%83%3Cpath d='M30 140c0-11 9-20 20-20s20 9 20 20-9 20-20 20-20-9-20-20z'/%E3%83%3Cpath d='M130 180l-10-10 10-10 10 10-10 10'/%E3%83%3C/g%E3%83%3C/svg%E3%83%3E");
        }

        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--card-bg);
            border: none;
            border-radius: 50%;
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .theme-toggle svg {
            width: 1.5rem;
            height: 1.5rem;
            color: var(--foreground);
        }

        .sun-icon {
            display: block;
        }

        .moon-icon {
            display: none;
        }

        .dark .sun-icon {
            display: none;
        }

        .dark .moon-icon {
            display: block;
        }

        .container {
            display: flex;
            flex-direction: row;
            width: 90%;
            max-width: 900px;
            background: var(--card-bg);
            box-shadow: 0px 0px 25px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            overflow: hidden;
            margin: 2rem auto;
        }

        .item, .login-form {
            width: 50%;
            position: relative;
        }

        .item {
            overflow: hidden;
        }

        .item-image {
            height: 100%;
            width: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .container:hover .item-image {
            transform: scale(1.05);
        }

        .overlay-effect {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            opacity: 0.3;
            background-color: #000;
            overflow: hidden;
            z-index: 1;
        }

        .item-details {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            color: white;
            text-align: left;
            z-index: 2;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
        }

        .item-details__title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: white;
            text-shadow: 0px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .item-details__subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .login-form {
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .form-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .form-header h2 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .form-header p {
            color: var(--foreground);
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .input-group label {
            position: absolute;
            top: 0.75rem;
            left: 1rem;
            color: var(--foreground);
            opacity: 0.6;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            pointer-events: none;
        }

        .input-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background-color: var(--card-bg);
            color: var(--foreground);
            font-size: 1rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .input-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
            outline: none;
        }

        .input-group input:focus + label,
        .input-group input:not(:placeholder-shown) + label {
            top: -0.5rem;
            left: 0.5rem;
            font-size: 0.75rem;
            padding: 0 0.25rem;
            background-color: var(--card-bg);
            color: var(--primary);
        }

        .password-container {
            position: relative;
        }

        .show-password {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--foreground);
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }

        .show-password:hover {
            opacity: 1;
        }

        .forgot-password {
            text-align: left;
            margin-bottom: 1.5rem;
        }

        .link-button {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0;
            text-decoration: underline;
            transition: color 0.2s ease;
        }

        .link-button:hover {
            color: var(--primary-hover);
        }

        .login-button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary);
            color: var(--primary-foreground);
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .login-button:hover {
            background-color: var(--primary-hover);
        }

        .signup-prompt {
            margin-left:-9px;
            margin-top: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            color: var(--foreground);
        }

        .signup-prompt a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .signup-prompt a:hover {
            text-decoration: underline;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            z-index: 1001;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .modal.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--foreground);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--foreground);
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-body p {
            margin-bottom: 1rem;
            color: var(--foreground);
            opacity: 0.8;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary);
            color: var(--primary-foreground);
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .modal-button:hover {
            background-color: var(--primary-hover);
        }

        .modal-button.cancel {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            margin-right: 0.5rem;
        }

        .modal-button.cancel:hover {
            background-color: #e2e8f0;
        }

        /* Loader */
        .loader {
            border: 4px solid rgba(34, 197, 94, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .button-loader {
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
            position: relative;
            top: -1px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Logout container */
        .logout-container {
            display: none;
            text-align: center;
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
        }

        .user-info {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: var(--secondary);
            border-radius: 0.5rem;
            color: var(--foreground);
        }

        .logout-button {
            margin-bottom: 1rem;
            background-color: var(--error);
        }

        .logout-button:hover {
            background-color: #dc2626;
        }

        .proceed-button {
            margin-top: 1rem;
        }

        /* Alert styles */
        .alert {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .alert-success {
            background-color: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                width: 95%;
                margin: 1rem auto;
            }

            .item, .login-form {
                width: 100%;
            }

            .item {
                height: 200px;
            }

            .login-form {
                padding: 1.5rem;
            }
        }

        /* Page loader */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark overlay for loader */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .page-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .page-loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(34, 197, 94, 0.2);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="login-bg-pattern">
    <!-- Page Loader -->
    <div class="page-loader" id="page-loader">
        <div class="page-loader-spinner"></div>
    </div>

    <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
        <!-- Sun icon for dark mode -->
        <svg xmlns="http://www.w3.org/2000/svg" class="sun-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <!-- Moon icon for light mode -->
        <svg xmlns="http://www.w3.org/2000/svg" class="moon-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <div id="auth-container">
        <!-- Login Container -->
        <div class="container" id="login-container">
            <div class="item">
                <img src="https://img.freepik.com/free-photo/serious-professional-designer-checks-designing-sketches-sits-desktop-reads-documentation_273609-18892.jpg" alt="CBT Practice" class="item-image">
                <div class="overlay-effect"></div>
                <div class="item-details">
                    <!-- Updated Course Title: GSS 302 -> GSS 202 (200lv) -->
                    <div class="item-details__title">Computer CBT Practice (200lv)</div>
                    <div class="item-details__subtitle">Access past questions for **Second semester**</div>
                </div>
            </div>
            <div class="login-form">
                <div class="form-header">
                    <h2>Welcome Back</h2>
                    <p>Sign in to continue to your account</p>
                </div>
                
                <div class="alert alert-error" id="login-error"></div>
                <div class="alert alert-success" id="login-success"></div>
                
                <form id="login-form">
                    <div class="input-group">
                        <input type="email" id="email" placeholder=" " required>
                        <label for="email">Email Address</label>
                    </div>
                    
                    <div class="input-group">
                        <div class="password-container">
                            <input type="password" id="password" placeholder=" " required>
                            <label for="password">Password</label>
                            <span class="show-password" id="toggle-password">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </span>
                        </div>
                    </div>
                    
                    <div class="forgot-password">
                        <button type="button" id="reset-password" class="link-button">Forgot Password?</button>
                    </div>
                    
                    <button type="button" id="login-button" class="login-button">
                        <span id="login-text">Sign In</span>
                        <div class="loader" id="login-loader"></div>
                    </button>
                </form>
                
                <div class="signup-prompt">
                    <p>Don't have an account? <a href="Signupcos.html">Subscribe here</a></p>
                </div>
            </div>
        </div>
        
        <!-- Signup Container (Hidden by default) -->
        <div class="container" id="signup-container" style="display: none;">
            <div class="item">
                <img src="https://img.freepik.com/free-photo/serious-professional-designer-checks-designing-sketches-sits-desktop-reads-documentation_273609-18892.jpg" alt="CBT Practice" class="item-image">
                <div class="overlay-effect"></div>
                <div class="item-details">
                    <div class="item-details__title">Computer CBT Practice (200lv)</div>
                    <div class="item-details__subtitle">Create your account to get started</div>
                </div>
            </div>
            <div class="login-form">
                <div class="form-header">
                    <h2>Create Account</h2>
                    <p>Sign up to access all features</p>
                </div>
                
                <div class="alert alert-error" id="signup-error"></div>
                <div class="alert alert-success" id="signup-success"></div>
                
                <form id="signup-form">
                    <div class="input-group">
                        <input type="email" id="signup-email" placeholder=" " required>
                        <label for="signup-email">Email Address</label>
                    </div>
                    
                    <div class="input-group">
                        <div class="password-container">
                            <input type="password" id="signup-password" placeholder=" " required>
                            <label for="signup-password">Password</label>
                            <span class="show-password" id="toggle-signup-password">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </span>
                        </div>
                    </div>
                    
                    <button type="button" id="signup-button" class="login-button">
                        <span id="signup-text">Create Account</span>
                        <div class="loader" id="signup-loader"></div>
                    </button>
                </form>
                
                <div class="signup-prompt">
                    <p>Already have an account? <a href="#" id="show-login">Sign In</a></p>
                </div>
            </div>
        </div>
        
        <!-- Logout Container (Hidden by default) -->
        <div class="logout-container" id="logout-container">
            <div class="form-header">
                <h2>Welcome</h2>
                <p>You are successfully logged in</p>
            </div>
            
            <div class="user-info" id="user-info">
                <!-- User info will be displayed here -->
            </div>
            
            <button class="login-button logout-button" id="logout-button">Sign Out</button>
            
            <a href="COS-chapters.html"> <!-- Updated Redirect Link: ENT-chapters.html -> GSS202-chapters.html -->
                <button class="login-button proceed-button">Proceed to your account</button>
            </a>
        </div>
    </div>
    
    <!-- Password Reset Modal -->
    <div class="modal-overlay" id="reset-modal-overlay">
        <div class="modal" id="reset-modal">
            <div class="modal-header">
                <h3>Reset Password</h3>
                <button class="modal-close" id="reset-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Enter your email address and we'll send you a link to reset your password.</p>
                <div class="input-group">
                    <input type="email" id="reset-email" placeholder=" " required>
                    <label for="reset-email">Email Address</label>
                </div>
                <div class="alert alert-error" id="reset-error"></div>
                <div class="alert alert-success" id="reset-success"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-button cancel" id="reset-cancel">Cancel</button>
                <button class="modal-button" id="reset-submit">
                    <span id="reset-text">Reset Password</span>
                    <div class="loader" id="reset-loader"></div>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            sendPasswordResetEmail, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged, 
            setPersistence, 
            browserLocalPersistence 
        } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

        // --- CONSTANTS ---
        const REDIRECT_PAGE_URL = "GSS202-chapters.html"; // CHANGED: ENT-chapters.html -> GSS202-chapters.html
        const COURSE_CODE = "GSS202"; // Added constant for course code
        const COURSE_LEVEL = "200lv"; // Added constant for course level

        // Firebase configuration (Retained from original file)
    const firebaseConfig = {
        apiKey: "AIzaSyAf0mERQ9WiocU34BQx4Isr48Hs1VfpbDU",
        authDomain: "database-login-530f7.firebaseapp.com",
        projectId: "database-login-530f7",
        storageBucket: "database-login-530f7.appspot.com",
        messagingSenderId: "280997222442",
        appId: "1:280997222442:web:ad80301ccb4337dfb70b53"
    };
        // Paystack Live Key (Retained from original file)
        const PAYSTACK_KEY = 'pk_live_64c23d6d8a53dbf350c549dce4e7e7423f146998'; 

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Set Firebase persistence to browser local
        setPersistence(auth, browserLocalPersistence).catch((error) => {
            console.error("Error setting persistence:", error);
        });

        // Enhanced browser fingerprinting
        const fpPromise = FingerprintJS.load({
            monitoring: false, 
            algorithm: 5 
        });

        // Get browser fingerprint with additional device information
        async function getBrowserFingerprint() {
            try {
                const fp = await fpPromise;
                const result = await fp.get();
                const visitorId = result.visitorId;
                
                const browserInfo = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    screenWidth: window.screen.width,
                    screenHeight: window.screen.height,
                    colorDepth: window.screen.colorDepth,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    cookiesEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack,
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                    deviceMemory: navigator.deviceMemory || 'unknown',
                    touchPoints: navigator.maxTouchPoints || 0
                };
                
                const combinedFingerprint = visitorId + JSON.stringify(browserInfo);
                
                // Create a hash of the combined fingerprint
                const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(combinedFingerprint));
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                return hashHex;
            } catch (error) {
                console.error("Error getting fingerprint:", error);
                return navigator.userAgent + navigator.language + navigator.platform + screen.width + screen.height;
            }
        }

        // Function to check if the email exists in Paystack transactions
        async function checkEmailWithPaystack(email) {
            // NOTE: This check should ideally be done server-side using the SECRET key,
            // but is implemented here as per the original file structure for front-end only check.
            try {
                const response = await fetch(`https://api.paystack.co/customer?email=${email}`, {
                    method: 'GET',
                    headers: {
                        // Using the public key here, which can only fetch public customer info
                        'Authorization': `Bearer ${PAYSTACK_KEY}` 
                    }
                });
                const data = await response.json();

                // Check if the Paystack API responded with success and contains customer data
                if (data.status && data.data && data.data.length > 0 && data.data[0].email === email) {
                    return true;
                } else {
                    return false;
                }
            } catch (error) {
                console.error("Error checking email with Paystack:", error);
                return false;
            }
        }

        // Show error message
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Show success message
        function showSuccess(elementId, message) {
            const successElement = document.getElementById(elementId);
            successElement.textContent = message;
            successElement.style.display = 'block';
            
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 5000);
        }

        // Show loading state
        function showLoading(buttonId, loaderId, textId) {
            document.getElementById(buttonId).disabled = true;
            document.getElementById(loaderId).style.display = 'block';
            document.getElementById(textId).style.display = 'none';
            
            document.getElementById('page-loader').style.display = 'flex';
        }

        // Hide loading state
        function hideLoading(buttonId, loaderId, textId) {
            document.getElementById(buttonId).disabled = false;
            document.getElementById(loaderId).style.display = 'none';
            document.getElementById(textId).style.display = 'block';
            
            document.getElementById('page-loader').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('page-loader').style.display = 'none';
            }, 500);
        }

        // Main login function
        async function loginUser() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showError('login-error', 'Please enter both email and password');
                return;
            }

            showLoading('login-button', 'login-loader', 'login-text');

            try {
                // Attempt to sign in with Firebase
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Get enhanced fingerprint
                const fingerprint = await getBrowserFingerprint();
                const userRef = doc(db, "userFingerprints", user.uid);
                const userDoc = await getDoc(userRef);

                // Check for an existing fingerprint to prevent duplicate sessions
                if (userDoc.exists()) {
                    const savedFingerprint = userDoc.data().fingerprint;
                    if (savedFingerprint && savedFingerprint !== fingerprint) {
                        // Log the login attempt for security monitoring
                        await setDoc(doc(db, "loginAttempts", `${user.uid}_${Date.now()}`), {
                            userId: user.uid,
                            email: user.email,
                            timestamp: serverTimestamp(),
                            fingerprint: fingerprint,
                            savedFingerprint: savedFingerprint,
                            status: 'rejected',
                            reason: 'different_device'
                        });
                        
                        hideLoading('login-button', 'login-loader', 'login-text');
                        showError('login-error', "Access denied! You are already logged in from another browser. Please log out first.");
                        await signOut(auth);
                        return;
                    }
                }

                // Save or update the user's fingerprint and last login
                await setDoc(userRef, { 
                    fingerprint,
                    lastLogin: serverTimestamp(),
                    email: user.email
                });
                
                // Log successful login
                await setDoc(doc(db, "loginAttempts", `${user.uid}_${Date.now()}`), {
                    userId: user.uid,
                    email: user.email,
                    timestamp: serverTimestamp(),
                    fingerprint: fingerprint,
                    status: 'success'
                });
                
                console.log("User logged in:", user);
                showUserInfo(user);
                showLogoutContainer();
            } catch (error) {
                hideLoading('login-button', 'login-loader', 'login-text');
                
                // Handle errors during Firebase authentication
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    // Check if email exists on Paystack to prompt for sign up if necessary
                    const paystackEmailExists = await checkEmailWithPaystack(email);

                    if (paystackEmailExists) {
                        // User exists on Paystack but not on Firebase, or wrong password.
                        // We assume if they paid, they should be able to create an account.
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('signup-container').style.display = 'flex';
                        document.getElementById('signup-email').value = email;
                        showError('signup-error', 'Login failed. We found a payment record for this email, but no account exists. Please create a password to sign up.');
                    } else {
                        showError('login-error', "Invalid login credentials or email not found. Please check your details.");
                    }
                } else if (error.code === 'auth/too-many-requests') {
                    showError('login-error', "Too many failed login attempts. Please try again later or reset your password.");
                } else {
                    console.error("Error logging in:", error);
                    showError('login-error', "Login failed: " + error.message);
                }
            }
        }

        // Sign up function (used when a payment is found but no Firebase account exists)
        async function signUpUser() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            if (!email || !password) {
                showError('signup-error', 'Please enter both email and password');
                return;
            }

            if (password.length < 6) {
                showError('signup-error', 'Password must be at least 6 characters');
                return;
            }

            showLoading('signup-button', 'signup-loader', 'signup-text');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const fingerprint = await getBrowserFingerprint();
                const userRef = doc(db, "userFingerprints", user.uid);
                await setDoc(userRef, { 
                    fingerprint,
                    email: user.email,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp()
                });

                // Create user profile (simplified)
                await setDoc(doc(db, "userProfiles", user.uid), {
                    email: user.email,
                    createdAt: serverTimestamp(),
                    subscription: {
                        status: "active",
                        plan: COURSE_CODE, // Changed from GSS302
                        level: COURSE_LEVEL, // Added level
                        startDate: serverTimestamp()
                    }
                });

                hideLoading('signup-button', 'signup-loader', 'signup-text');
                showSuccess('signup-success', 'Account created successfully! You are now logged in.');
                
                setTimeout(() => {
                    showUserInfo(user);
                    showLogoutContainer();
                }, 1500);
            } catch (error) {
                hideLoading('signup-button', 'signup-loader', 'signup-text');
                
                if (error.code === 'auth/email-already-in-use') {
                    showError('signup-error', 'This email is already registered. Please log in instead.');
                } else {
                    console.error("Error signing up:", error);
                    showError('signup-error', "Sign up failed: " + error.message);
                }
            }
        }

        // Reset password function
        async function resetPassword() {
            const email = document.getElementById('reset-email').value;

            if (!email) {
                showError('reset-error', 'Please enter your email address');
                return;
            }

            showLoading('reset-submit', 'reset-loader', 'reset-text');

            try {
                await sendPasswordResetEmail(auth, email);
                hideLoading('reset-submit', 'reset-loader', 'reset-text');
                showSuccess('reset-success', 'Password reset email sent. Please check your inbox.');
                
                setTimeout(() => {
                    closeResetModal();
                }, 3000);
            } catch (error) {
                hideLoading('reset-submit', 'reset-loader', 'reset-text');
                
                if (error.code === 'auth/user-not-found') {
                    showError('reset-error', 'No account found with this email address.');
                } else {
                    console.error("Error sending reset email:", error);
                    showError('reset-error', "Error sending password reset email: " + error.message);
                }
            }
        }

        // Log out user and clear fingerprint
        async function logOutUser() {
            const user = auth.currentUser;
            if (user) {
                try {
                    const userRef = doc(db, "userFingerprints", user.uid);
                    await setDoc(userRef, { 
                        fingerprint: null,
                        lastLogout: serverTimestamp()
                    }, { merge: true });
                    
                    await signOut(auth);
                    console.log("User signed out.");
                    showLoginContainer();
                } catch (error) {
                    console.error("Error signing out:", error);
                    showError('login-error', "Error signing out: " + error.message);
                }
            }
        }

        // Show user info
        function showUserInfo(user) {
            const userInfo = document.getElementById('user-info');
            userInfo.innerHTML = `
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>Status:</strong> Active</p>
            `;
            // Update the proceed button URL
            document.querySelector('#logout-container a').href = REDIRECT_PAGE_URL;
        }

        // Show login container
        function showLoginContainer() {
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('signup-container').style.display = 'none';
            document.getElementById('logout-container').style.display = 'none';
        }

        // Show logout container
        function showLogoutContainer() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('signup-container').style.display = 'none';
            document.getElementById('logout-container').style.display = 'block';
        }

        // Open reset password modal
        function openResetModal() {
            document.getElementById('reset-modal-overlay').style.display = 'block';
            setTimeout(() => {
                document.getElementById('reset-modal').classList.add('active');
                document.getElementById('reset-email').focus();
            }, 10);
        }

        // Close reset password modal
        function closeResetModal() {
            document.getElementById('reset-modal').classList.remove('active');
            setTimeout(() => {
                document.getElementById('reset-modal-overlay').style.display = 'none';
                document.getElementById('reset-email').value = '';
                document.getElementById('reset-error').style.display = 'none';
                document.getElementById('reset-success').style.display = 'none';
            }, 300);
        }

        // Toggle password visibility
        function togglePasswordVisibility(inputId, toggleId) {
            const passwordInput = document.getElementById(inputId);
            const toggleButton = document.getElementById(toggleId);
            const iconHtml = passwordInput.type === 'password'
                ? `<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>`
                : `<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>`;
            
            passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
            toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${iconHtml}</svg>`;
        }

        // Initialize theme
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.toggle("dark", savedTheme === 'dark');

            const themeToggle = document.getElementById('themeToggle');
            themeToggle.addEventListener('click', () => {
                const isDark = document.body.classList.toggle("dark");
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });

            const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");
            prefersDarkScheme.addEventListener("change", (e) => {
                document.body.classList.toggle("dark", e.matches);
                localStorage.setItem('theme', e.matches ? 'dark' : 'light');
            });
        }

        // Hide page loader
        function hidePageLoader() {
            const pageLoader = document.getElementById('page-loader');
            pageLoader.classList.add('hidden');
            setTimeout(() => {
                pageLoader.style.display = 'none';
            }, 500);
        }

        // Monitor Firebase auth state to update UI
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Initial check after loading to determine if user is already logged in
                try {
                    const fingerprint = await getBrowserFingerprint();
                    const userRef = doc(db, "userFingerprints", user.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const savedFingerprint = userDoc.data().fingerprint;
                        if (savedFingerprint && savedFingerprint !== fingerprint && savedFingerprint !== null) {
                            console.warn("Fingerprint mismatch detected on load.");
                            await signOut(auth);
                            showLoginContainer(); // Show login to force re-auth
                        } else {
                            showUserInfo(user);
                            showLogoutContainer();
                        }
                    } else {
                        // This case should ideally not happen if user signed up correctly, but handle defensively
                        showUserInfo(user);
                        showLogoutContainer();
                    }
                } catch (error) {
                    console.error("Error verifying user on load:", error);
                    showLoginContainer();
                }
            } else {
                showLoginContainer();
            }
            hidePageLoader();
        });

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme
            initializeTheme();
            
            document.getElementById('login-button').addEventListener('click', loginUser);
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                loginUser();
            });
            document.getElementById('signup-button').addEventListener('click', signUpUser);
            document.getElementById('signup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                signUpUser();
            });
            document.getElementById('logout-button').addEventListener('click', logOutUser);
            document.getElementById('reset-password').addEventListener('click', openResetModal);
            document.getElementById('reset-modal-close').addEventListener('click', closeResetModal);
            document.getElementById('reset-cancel').addEventListener('click', closeResetModal);
            document.getElementById('reset-submit').addEventListener('click', resetPassword);
            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('signup-container').style.display = 'none';
                document.getElementById('login-container').style.display = 'flex';
            });
            
            document.getElementById('toggle-password').addEventListener('click', () => {
                togglePasswordVisibility('password', 'toggle-password');
            });
            document.getElementById('toggle-signup-password').addEventListener('click', () => {
                togglePasswordVisibility('signup-password', 'toggle-signup-password');
            });
            
            document.getElementById('reset-modal-overlay').addEventListener('click', (e) => {
                if (e.target === document.getElementById('reset-modal-overlay')) {
                    closeResetModal();
                }
            });

            // Hide page loader after a short delay if auth state hasn't changed
            setTimeout(hidePageLoader, 1500);
        });
    </script>
</body>
</html>