<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - CBT Practice</title>
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <style>
        :root {
            --background: #f8fafc;
            --foreground: #1f2937;
            --card-bg: #ffffff;
            --card-foreground: #1f2937;
            --primary: #22c55e;
            --primary-foreground: #ffffff;
            --primary-hover: #16a34a;
            --secondary: #f1f5f9;
            --secondary-foreground: #1f2937;
            --border: #e2e8f0;
            --ring: #22c55e;
            --error: #ef4444;
            --success: #22c55e;
        }

        .dark {
            --background: #1f2937;
            --foreground: #f8fafc;
            --card-bg: #374151;
            --card-foreground: #f8fafc;
            --primary: #22c55e;
            --primary-foreground: #ffffff;
            --primary-hover: #16a34a;
            --secondary: #334155;
            --secondary-foreground: #f8fafc;
            --border: #4b5563;
            --ring: #22c55e;
            --error: #ef4444;
            --success: #22c55e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            line-height: 1.5;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .signup-bg-pattern {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cg fill='none' stroke='%23d1d5db' stroke-width='1'%3E%3Crect width='40' height='40' x='10' y='10'/%3E%3Ccircle cx='130' cy='30' r='20'/%3E%3Cpath d='M170 100l-20 20 20 20 20-20z'/%3E%3Cpath d='M30 140c0-11 9-20 20-20s20 9 20 20-9 20-20 20-20-9-20-20z'/%3E%3Cpath d='M130 180l-10-10 10-10 10 10-10 10'/%3E%3C/g%3E%3C/svg%3E");
        }

        .dark .signup-bg-pattern {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cg fill='none' stroke='%23374151' stroke-width='1'%3E%3Crect width='40' height='40' x='10' y='10'/%3E%3Ccircle cx='130' cy='30' r='20'/%3E%3Cpath d='M170 100l-20 20 20 20 20-20z'/%3E%3Cpath d='M30 140c0-11 9-20 20-20s20 9 20 20-9 20-20 20-20-9-20-20z'/%3E%3Cpath d='M130 180l-10-10 10-10 10 10-10 10'/%3E%3C/g%3E%3C/svg%3E");
        }

        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--card-bg);
            border: none;
            border-radius: 50%;
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .theme-toggle svg {
            width: 1.5rem;
            height: 1.5rem;
            color: var(--foreground);
        }

        .sun-icon {
            display: block;
        }

        .moon-icon {
            display: none;
        }

        .dark .sun-icon {
            display: none;
        }

        .dark .moon-icon {
            display: block;
        }

        .container {
            display: flex;
            flex-direction: row;
            width: 90%;
            max-width: 900px;
            background: var(--card-bg);
            box-shadow: 0px 0px 25px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            overflow: hidden;
            margin: 2rem auto;
        }

        .item, .signup-form {
            width: 50%;
            position: relative;
        }

        .item {
            overflow: hidden;
        }

        .item-image {
            height: 100%;
            width: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .container:hover .item-image {
            transform: scale(1.05);
        }

        .overlay-effect {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            opacity: 0.3;
            background-color: #000;
            overflow: hidden;
            z-index: 1;
        }

        .item-details {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            color: white;
            text-align: left;
            z-index: 2;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
        }

        .item-details__title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: white;
            text-shadow: 0px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .item-details__amount {
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .signup-form {
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .form-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .form-header h2 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .form-header p {
            color: var(--foreground);
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .input-group label {
            position: absolute;
            top: 0.75rem;
            left: 1rem;
            color: var(--foreground);
            opacity: 0.6;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            pointer-events: none;
        }

        .input-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background-color: var(--card-bg);
            color: var(--foreground);
            font-size: 1rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .input-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
            outline: none;
        }

        .input-group input:focus + label,
        .input-group input:not(:placeholder-shown) + label {
            top: -0.5rem;
            left: 0.5rem;
            font-size: 0.75rem;
            padding: 0 0.25rem;
            background-color: var(--card-bg);
            color: var(--primary);
        }

        .input-group input:disabled {
            background-color: var(--secondary);
            cursor: not-allowed;
        }

        .password-container {
            position: relative;
        }

        .show-password {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--foreground);
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }

        .show-password:hover {
            opacity: 1;
        }

        .signup-button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary);
            color: var(--primary-foreground);
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
            margin-top: 1rem;
        }

        .signup-button:hover {
            background-color: var(--primary-hover);
        }

        .login-prompt {
            margin-top: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            color: var(--foreground);
        }

        .login-prompt a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .login-prompt a:hover {
            text-decoration: underline;
        }

        /* Password strength meter */
        .password-strength {
            margin-top: -1rem;
            margin-bottom: 1rem;
            font-size: 0.8rem;
        }

        .password-strength-meter {
            height: 4px;
            background-color: var(--border);
            border-radius: 2px;
            margin-top: 0.25rem;
            overflow: hidden;
        }

        .password-strength-meter-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease, background-color 0.3s ease;
            width: 0;
        }

        .strength-weak {
            background-color: var(--error);
            color: var(--error);
        }

        .strength-medium {
            background-color: #f59e0b;
            color: #f59e0b;
        }

        .strength-strong {
            background-color: var(--success);
            color: var(--success);
        }

        /* Loader */
        .loader {
            border: 4px solid rgba(34, 197, 94, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert styles */
        .alert {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .alert-success {
            background-color: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        /* Success container */
        .success-container {
            display: none;
            text-align: center;
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            color: var(--primary);
        }

        .success-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .success-message {
            margin-bottom: 1.5rem;
            color: var(--foreground);
        }

        .proceed-button {
            margin-top: 1rem;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                width: 95%;
                margin: 1rem auto;
            }

            .item, .signup-form {
                width: 100%;
            }

            .item {
                height: 200px;
            }

            .signup-form {
                padding: 1.5rem;
            }
        }

        /* Page loader */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark overlay for loader */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .page-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .page-loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(34, 197, 94, 0.2);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Payment status indicator */
        .payment-status {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: var(--card-bg);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
            align-items: center;
            z-index: 100;
        }

        .payment-status-icon {
            margin-right: 0.5rem;
            color: var(--primary);
        }

        .payment-status-text {
            font-size: 0.9rem;
            color: var(--foreground);
        }
    </style>
</head>
<body class="signup-bg-pattern">
    <!-- Page Loader -->
    <div class="page-loader" id="page-loader">
        <div class="page-loader-spinner"></div>
    </div>

    <!-- Payment Status Indicator -->
    <div class="payment-status" id="payment-status">
        <div class="payment-status-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </div>
        <div class="payment-status-text" id="payment-status-text">
            Payment in progress...
        </div>
    </div>

    <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
        <!-- Sun icon for dark mode -->
        <svg xmlns="http://www.w3.org/2000/svg" class="sun-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <!-- Moon icon for light mode -->
        <svg xmlns="http://www.w3.org/2000/svg" class="moon-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <div id="auth-container">
        <!-- Signup Container -->
        <div class="container" id="signup-container">
            <div class="item">
                <img src="https://img.freepik.com/free-photo/serious-professional-designer-checks-designing-sketches-sits-desktop-reads-documentation_273609-18892.jpg" alt="CBT Practice" class="item-image">
                <div class="overlay-effect"></div>
                <div class="item-details">
                    <div class="item-details__title">GST 121 CBT Practice (UNIUYO)</div>
                    <div class="item-details__amount">₦200</div>
                </div>
            </div>
            <div class="signup-form">
                <div class="form-header">
                    <h2>Create Account</h2>
                    <p>Sign up and pay to access all features</p>
                </div>
                
                <div class="alert alert-error" id="signup-error"></div>
                <div class="alert alert-success" id="signup-success"></div>
                
                <form id="paymentForm">
                    <div class="input-group">
                        <input type="text" id="name" placeholder=" " required>
                        <label for="name">Full Name</label>
                    </div>
                    
                    <div class="input-group">
                        <input type="email" id="email" placeholder=" " required>
                        <label for="email">Email Address</label>
                    </div>
                    
                    <div class="input-group">
                        <div class="password-container">
                            <input type="password" id="password" placeholder=" " required>
                            <label for="password">Password</label>
                            <span class="show-password" id="toggle-password">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </span>
                        </div>
                    </div>
                    
                    <!-- Password strength meter -->
                    <div class="password-strength" id="password-strength">
                        <div class="password-strength-text">Password strength: <span id="strength-text">None</span></div>
                        <div class="password-strength-meter">
                            <div class="password-strength-meter-fill" id="strength-meter"></div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <input type="tel" id="amount" value="200" disabled>
                        <label for="amount">Amount (₦)</label>
                    </div>
                    
                    <button type="button" id="signup-button" class="signup-button">
                        <span id="signup-text">Pay ₦200</span>
                        <div class="loader" id="signup-loader"></div>
                    </button>
                </form>
                
                <div class="login-prompt">
                    <p>Already have an account? <a href="Loginobiokpa.html">Sign In</a></p>
                </div>
            </div>
        </div>
        
        <!-- Success Container (Hidden by default) -->
        <div class="success-container" id="success-container">
            <div class="success-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </div>
            <div class="success-title">Payment Successful!</div>
            <div class="success-message">
                <p>Your account has been created and your payment has been processed successfully.</p>
                <p>You now have full access to all CBT Practice features.</p>
            </div>
            <a href="GST121-cbt.html">
                <button class="signup-button proceed-button">Proceed to your account</button>
            </a>
        </div>
    </div>

    <!-- Paystack JS Library -->
    <script src="https://js.paystack.co/v2/inline.js"></script>
    <!-- FingerprintJS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
    apiKey: "AIzaSyCtQ6A7U6owqhzbsX_sIeaOuz2JlapMjC8",
    authDomain: "cbt-practice-90351.firebaseapp.com",
    databaseURL: "https://cbt-practice-90351-default-rtdb.firebaseio.com",
    projectId: "cbt-practice-90351",
    storageBucket: "cbt-practice-90351.appspot.com",
    messagingSenderId: "985955090547",
    appId: "1:985955090547:web:bfc56516e8318ce296aa06",
  };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Initialize FingerprintJS
        const fpPromise = FingerprintJS.load({
            monitoring: false, // Disable monitoring to avoid unnecessary network requests
            algorithm: 5 // Use the most accurate algorithm
        });

        // Get browser fingerprint with additional device information
        async function getBrowserFingerprint() {
            try {
                // Get FingerprintJS visitor ID
                const fp = await fpPromise;
                const result = await fp.get();
                const visitorId = result.visitorId;
                
                // Collect additional browser information
                const browserInfo = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    screenWidth: window.screen.width,
                    screenHeight: window.screen.height,
                    colorDepth: window.screen.colorDepth,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    cookiesEnabled: navigator.cookieEnabled,
                    doNotTrack: navigator.doNotTrack,
                    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                    deviceMemory: navigator.deviceMemory || 'unknown',
                    touchPoints: navigator.maxTouchPoints || 0
                };
                
                // Combine fingerprint with browser info for stronger identification
                const combinedFingerprint = visitorId + JSON.stringify(browserInfo);
                
                // Create a hash of the combined fingerprint
                const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(combinedFingerprint));
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                return hashHex;
            } catch (error) {
                console.error("Error getting fingerprint:", error);
                // Fallback to a basic fingerprint if advanced method fails
                return navigator.userAgent + navigator.language + navigator.platform + screen.width + screen.height;
            }
        }

        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('signup-error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Show success message
        function showSuccess(message) {
            const successElement = document.getElementById('signup-success');
            successElement.textContent = message;
            successElement.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 5000);
        }

        // Show loading state
        function showLoading() {
            document.getElementById('signup-button').disabled = true;
            document.getElementById('signup-loader').style.display = 'block';
            document.getElementById('signup-text').style.display = 'none';
            document.getElementById('page-loader').style.display = 'flex';
        }

        // Hide loading state
        function hideLoading() {
            document.getElementById('signup-button').disabled = false;
            document.getElementById('signup-loader').style.display = 'none';
            document.getElementById('signup-text').style.display = 'block';
            
            // Hide page loader
            document.getElementById('page-loader').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('page-loader').style.display = 'none';
            }, 500);
        }

        // Show payment status
        function showPaymentStatus(message, isVisible = true) {
            const statusElement = document.getElementById('payment-status');
            const statusTextElement = document.getElementById('payment-status-text');
            
            statusTextElement.textContent = message;
            statusElement.style.display = isVisible ? 'flex' : 'none';
        }

        // Show success container
        function showSuccessContainer() {
            document.getElementById('signup-container').style.display = 'none';
            document.getElementById('success-container').style.display = 'block';
        }

        // Initialize theme
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.toggle("dark", savedTheme === 'dark');

            // Theme toggle button
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.addEventListener('click', () => {
                const isDark = document.body.classList.toggle("dark");
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });

            // Automatically switch theme based on user's system preference
            const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");
            prefersDarkScheme.addEventListener("change", (e) => {
                document.body.classList.toggle("dark", e.matches);
                localStorage.setItem('theme', e.matches ? 'dark' : 'light');
            });
        }

        // Hide page loader
        function hidePageLoader() {
            const pageLoader = document.getElementById('page-loader');
            pageLoader.classList.add('hidden');
            setTimeout(() => {
                pageLoader.style.display = 'none';
            }, 500);
        }

        // Check password strength
        function checkPasswordStrength(password) {
            const strengthMeter = document.getElementById('strength-meter');
            const strengthText = document.getElementById('strength-text');
            
            // Remove all classes
            strengthMeter.classList.remove('strength-weak', 'strength-medium', 'strength-strong');
            
            if (!password) {
                strengthMeter.style.width = '0%';
                strengthText.textContent = 'None';
                return;
            }
            
            // Check password strength
            let strength = 0;
            
            // Length check
            if (password.length >= 8) strength += 1;
            if (password.length >= 12) strength += 1;
            
            // Character variety checks
            if (/[A-Z]/.test(password)) strength += 1;
            if (/[a-z]/.test(password)) strength += 1;
            if (/[0-9]/.test(password)) strength += 1;
            if (/[^A-Za-z0-9]/.test(password)) strength += 1;
            
            // Set strength meter
            if (strength <= 2) {
                strengthMeter.style.width = '33%';
                strengthMeter.classList.add('strength-weak');
                strengthText.textContent = 'Weak';
                strengthText.className = 'strength-weak';
            } else if (strength <= 4) {
                strengthMeter.style.width = '66%';
                strengthMeter.classList.add('strength-medium');
                strengthText.textContent = 'Medium';
                strengthText.className = 'strength-medium';
            } else {
                strengthMeter.style.width = '100%';
                strengthMeter.classList.add('strength-strong');
                strengthText.textContent = 'Strong';
                strengthText.className = 'strength-strong';
            }
        }

        // Save payment session to localStorage
        function savePaymentSession(data) {
            localStorage.setItem('paymentSession', JSON.stringify({
                ...data,
                timestamp: Date.now()
            }));
        }

        // Get payment session from localStorage
        function getPaymentSession() {
            const session = localStorage.getItem('paymentSession');
            if (!session) return null;
            
            try {
                const parsedSession = JSON.parse(session);
                
                // Check if session is still valid (24 hours)
                const now = Date.now();
                const sessionTime = parsedSession.timestamp || 0;
                const sessionAge = now - sessionTime;
                
                if (sessionAge > 24 * 60 * 60 * 1000) {
                    // Session expired
                    localStorage.removeItem('paymentSession');
                    return null;
                }
                
                return parsedSession;
            } catch (error) {
                console.error("Error parsing payment session:", error);
                localStorage.removeItem('paymentSession');
                return null;
            }
        }

        // Clear payment session
        function clearPaymentSession() {
            localStorage.removeItem('paymentSession');
            showPaymentStatus('', false);
        }

        // Create user in Firebase
        async function createFirebaseUser(email, password, userData, paymentRef) {
            try {
                // Create user with Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Get browser fingerprint
                const fingerprint = await getBrowserFingerprint();
                
                // Store user data in Firestore
                await setDoc(doc(db, "users", user.uid), {
                    ...userData,
                    email: user.email,
                    createdAt: serverTimestamp(),
                    paymentReference: paymentRef,
                    fingerprint: fingerprint,
                    lastLogin: serverTimestamp()
                });
                
                // Store fingerprint for session management
                await setDoc(doc(db, "userFingerprints", user.uid), {
                    fingerprint: fingerprint,
                    email: user.email,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp()
                });
                
                // Store payment information
                await setDoc(doc(db, "payments", paymentRef), {
                    userId: user.uid,
                    email: user.email,
                    amount: 200,
                    currency: 'NGN',
                    status: 'success',
                    reference: paymentRef,
                    timestamp: serverTimestamp(),
                    metadata: {
                        name: userData.name,
                        fingerprint: fingerprint
                    }
                });
                
                console.log("User created successfully:", user.uid);
                return user;
            } catch (error) {
                console.error("Error creating user:", error);
                
                // If user already exists, try to sign in
                if (error.code === 'auth/email-already-in-use') {
                    try {
                        // Sign in existing user
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        
                        // Update payment information
                        await setDoc(doc(db, "payments", paymentRef), {
                            userId: user.uid,
                            email: user.email,
                            amount: 200,
                            currency: 'NGN',
                            status: 'success',
                            reference: paymentRef,
                            timestamp: serverTimestamp()
                        });
                        
                        console.log("Existing user signed in:", user.uid);
                        return user;
                    } catch (signInError) {
                        console.error("Error signing in existing user:", signInError);
                        throw new Error("This email is already registered but the password is incorrect. Please use a different email or try to log in.");
                    }
                }
                
                throw error;
            }
        }

        // Function to handle the payment and sign-up process
        async function payWithPaystack() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            // Validate inputs
            if (!name || !email || !password) {
                showError('Please fill in all fields');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            // Check if there's an existing payment session
            const existingSession = getPaymentSession();
            if (existingSession && existingSession.status === 'pending') {
                showPaymentStatus('Resuming previous payment...', true);
                
                // Check if the payment was completed
                try {
                    const response = await fetch(`https://api.paystack.co/transaction/verify/${existingSession.reference}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer pk_live_64c23d6d8a53dbf350c549dce4e7e7423f146998`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.status && data.data.status === 'success') {
                        // Payment was successful, create user
                        showPaymentStatus('Payment verified! Creating your account...', true);
                        
                        try {
                            await createFirebaseUser(email, password, {
                                name: name
                            }, existingSession.reference);
                            
                            // Clear payment session
                            clearPaymentSession();
                            
                            // Show success
                            showSuccessContainer();
                        } catch (error) {
                            showError(error.message || "Error creating user account");
                            clearPaymentSession();
                        }
                        
                        return;
                    }
                } catch (error) {
                    console.error("Error verifying payment:", error);
                    // Continue with new payment
                }
            }

            // Show loading state
            showLoading();
            showPaymentStatus('Initializing payment...', true);

            // Save user data for persistence
            const userData = {
                name,
                email,
                password
            };
            
            try {
                // Generate a unique reference
                const reference = 'CBT_' + Date.now() + '_' + Math.floor(Math.random() * 1000000);
                
                // Save payment session
                savePaymentSession({
                    name,
                    email,
                    reference,
                    status: 'pending'
                });
                
                // Paystack payment initialization
                const paystack = new PaystackPop();
                paystack.newTransaction({
                    key: 'pk_live_64c23d6d8a53dbf350c549dce4e7e7423f146998',
                    email: email,
                    amount: 20000, // Amount in kobo (200 NGN)
                    currency: 'NGN',
                    ref: reference,
                    metadata: {
                        custom_fields: [
                            {
                                display_name: "Full Name",
                                variable_name: "full_name",
                                value: name
                            }
                        ]
                    },
                    onSuccess: async function(response) {
                        // Payment was successful
                        showPaymentStatus('Payment successful! Creating your account...', true);
                        
                        try {
                            // Create user in Firebase
                            await createFirebaseUser(email, password, {
                                name: name
                            }, response.reference);
                            
                            // Clear payment session
                            clearPaymentSession();
                            
                            // Hide loading and show success
                            hideLoading();
                            showSuccessContainer();
                        } catch (error) {
                            hideLoading();
                            showError(error.message || "Error creating user account");
                            clearPaymentSession();
                        }
                    },
                    onCancel: function() {
                        hideLoading();
                        showPaymentStatus('Payment canceled. You can resume later.', true);
                        setTimeout(() => {
                            showPaymentStatus('', false);
                        }, 5000);
                    }
                });
            } catch (error) {
                console.error("Error initializing Paystack:", error);
                hideLoading();
                showError("Error initializing payment: " + error.message);
                clearPaymentSession();
            }
        }

        // Check for existing payment session on page load
        window.addEventListener('load', () => {
            // Initialize theme
            initializeTheme();
            
            // Check for existing payment session
            const session = getPaymentSession();
            if (session) {
                // Fill in the form fields
                document.getElementById('name').value = session.name || '';
                document.getElementById('email').value = session.email || '';
                
                // Show payment status
                if (session.status === 'pending') {
                    showPaymentStatus('You have a pending payment. Continue where you left off.', true);
                }
                
                // Show a message
                showSuccess('We found your previous session. You can continue with your payment.');
            }
            
            // Hide page loader after a short delay
            setTimeout(hidePageLoader, 1000);
        });

        // Password strength checker
        document.getElementById('password').addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });

        // Toggle password visibility
        document.getElementById('toggle-password').addEventListener('click', () => {
            const passwordInput = document.getElementById('password');
            const toggleButton = document.getElementById('toggle-password');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                `;
            } else {
                passwordInput.type = 'password';
                toggleButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                `;
            }
        });
        
        // Handle form submission
        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            payWithPaystack();
        });
        
        // Attach event listener to the sign-up button
        document.getElementById('signup-button').addEventListener('click', function(e) {
            e.preventDefault();
            payWithPaystack();
        });

        // Handle beforeunload event to warn user if payment is in progress
        window.addEventListener('beforeunload', function(e) {
            const session = getPaymentSession();
            if (session && session.status === 'pending') {
                // Show a confirmation message
                const confirmationMessage = 'You have a payment in progress. Are you sure you want to leave?';
                e.returnValue = confirmationMessage;
                return confirmationMessage;
            }
        });
    </script>
</body>
</html>