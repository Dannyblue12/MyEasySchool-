<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKSU EXAMS SIMULATION - CBT</title>
    <style>
        body {
            background-color: #4CAF50;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            line-height: 1.6;
            color: #000;
            transition: opacity 0.5s ease;
        }

        body.loaded {
            opacity: 1;
        }

        .timer {
            text-align: right;
            font-size: 1.4em;
            color: #FF4444;
            font-weight: 600;
            font-family: 'Arial', sans-serif;
            margin-right: 20px;
            margin-top: 10px;
        }

        .hidden {
            display: none !important;
        }

        header {
            background-color: #1E1E4D;
            color: #fff;
            text-align: center;
            padding: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 28px;
            margin: 0;
            letter-spacing: 0.5px;
        }

        h3 {
            margin: 10px 0 0;
            font-weight: 500;
            opacity: 0.9;
        }

        main {
            max-width: 800px;
            margin: 20px auto;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #quiz-container {
            margin-bottom: 20px;
        }

        #question {
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        #choices {
            list-style: none;
            padding: 0;
        }

        #choices li {
            margin-bottom: 12px;
        }

        #choices label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
        }

        input[type="radio"] {
            margin-right: 10px;
            -webkit-appearance: none;
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.15em;
            height: 1.15em;
            border: 0.15em solid currentColor;
            border-radius: 50%;
            transform: translateY(-0.075em);
            display: grid;
            place-content: center;
            margin-right: 10px;
        }

        input[type="radio"]::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            border-radius: 50%;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #1E1E4D;
        }

        input[type="radio"]:checked::before {
            transform: scale(1);
        }

        .btn {
            background-color: #1E1E4D;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 16px;
            font-weight: 500;
        }

        .btn:hover {
            background-color: #2a2a6a;
        }

        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        #result-container {
            text-align: center;
        }

        #score {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        #answers-list {
            list-style: none;
            text-align: left;
            margin-top: 20px;
            padding: 0;
        }

        #answers-list li {
            margin-bottom: 10px;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        #answers-list .correct {
            color: #1E1E4D;
            background-color: #e6ffe6;
        }

        #answers-list .incorrect {
            color: #1E1E4D;
            background-color: #ffe6e6;
        }

        .loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #4CAF50;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #fff;
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
            margin-bottom: 20px;
        }

        .loader-text {
            color: #fff;
            font-size: 18px;
            font-weight: 500;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .unauthorized-message {
            text-align: center;
            padding: 40px 20px;
        }

        .unauthorized-message h2 {
            color: #fff;
            margin-bottom: 20px;
        }

        .unauthorized-message p {
            color: #eee;
            margin-bottom: 30px;
        }

        .activate-btn {
            background-color: #00C853;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .activate-btn:hover {
            background-color: #00B34A;
        }

        .confirmation-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 90%;
            width: 400px;
        }

        .confirmation-dialog p {
            margin-bottom: 25px;
            font-size: 20px;
            color: #333;
        }

        .confirmation-dialog button {
            margin: 0 10px;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .confirmation-dialog button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        #confirm-submit {
            background-color: #4CAF50;
            color: white;
        }

        #cancel-submit {
            background-color: #f44336;
            color: white;
        }

        #topic-analysis {
            margin-top: 20px;
            text-align: left;
        }

        .topic-performance {
            margin-bottom: 15px;
        }

        .topic-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .performance-bar {
            background-color: #e0e0e0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }

        .performance-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.5s ease-in-out;
        }

        #strengths-improvements {
            margin-top: 20px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="loader" class="loader-container">
        <div class="loader"></div>
        <p class="loader-text">Checking authorization...</p>
    </div>

    <header>
        <h1 id="universityHeader">AKSU EXAMS SIMULATION</h1>
        <h3 id="courseHeader">CBT</h3>
    </header>

    <div class="timer hidden">
        <span id="countdownHours">00</span>:
        <span id="countdownMinutes">00</span>:
        <span id="countdownSeconds">00</span>
    </div>

    <main class="hidden">
        <section id="unauthorized-message" class="unauthorized-message hidden">
            <h2>Access Required</h2>
            <p>Please sign in to access the exam mode.</p>
            <a href="sign-in.html" class="activate-btn">Sign In</a>
        </section>

        <section id="quiz-container" class="hidden">
            <p id="question"></p>
            <ul id="choices"></ul>
            <div class="navigation-buttons">
                <button id="prev-btn" class="btn">Previous</button>
                <button id="next-btn" class="btn">Next</button>
            </div>
        </section>

        <div id="result-container" class="hidden">
            <p id="score"></p>
            <button id="show-answers-btn" class="btn">Show Answers</button>
            <button id="restart-btn" class="btn">Restart</button>
            <div id="topic-analysis"></div>
            <div id="strengths-improvements"></div>
            <ul id="answers-list"></ul>
        </div>
    </main>

    <div id="confirmation-dialog" class="confirmation-dialog hidden">
        <p>Are you sure you want to submit?</p>
        <button id="confirm-submit" class="btn">Yes</button>
        <button id="cancel-submit" class="btn">No</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Constants
            const API_BASE = "https://my-easy-school-api.onrender.com/api";
            const EXAM_DURATION = 900; // 15 minutes in seconds

            // DOM Elements
            const elements = {
                loader: document.getElementById('loader'),
                mainContent: document.querySelector('main'),
                unauthorizedMessage: document.getElementById('unauthorized-message'),
                quizContainer: document.getElementById('quiz-container'),
                resultContainer: document.getElementById('result-container'),
                questionElement: document.getElementById('question'),
                choicesElement: document.getElementById('choices'),
                prevButton: document.getElementById('prev-btn'),
                nextButton: document.getElementById('next-btn'),
                scoreElement: document.getElementById('score'),
                showAnswersButton: document.getElementById('show-answers-btn'),
                restartButton: document.getElementById('restart-btn'),
                timerElement: document.querySelector('.timer'),
                answersListElement: document.getElementById('answers-list'),
                confirmationDialog: document.getElementById('confirmation-dialog'),
                confirmSubmitButton: document.getElementById('confirm-submit'),
                cancelSubmitButton: document.getElementById('cancel-submit'),
                topicAnalysisElement: document.getElementById('topic-analysis'),
                strengthsImprovementsElement: document.getElementById('strengths-improvements'),
                countdownHours: document.getElementById('countdownHours'),
                countdownMinutes: document.getElementById('countdownMinutes'),
                countdownSeconds: document.getElementById('countdownSeconds'),
                courseHeader: document.getElementById('courseHeader'),
                universityHeader: document.getElementById('universityHeader')
            };

            // Quiz State
            const state = {
                quizData: [],
                currentQuestionIndex: 0,
                selectedAnswers: {},
                timeLeft: EXAM_DURATION,
                timerInterval: null,
                isQuizActive: false,
                courseId: null,
                courseCode: null,
                cbtId: null,
                detailedResults: null // Added to store detailed results from API
            };

            // Get URL parameters
            function getUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                state.courseId = urlParams.get('courseId');
                state.courseCode = urlParams.get('courseCode');
                
                console.log('[v0] Course ID:', state.courseId);
                console.log('[v0] Course Code:', state.courseCode);
                
                if (state.courseCode) {
                    elements.courseHeader.textContent = `${state.courseCode} CBT`;
                }
            }

            // Get user token from localStorage
            function getUserToken() {
                return localStorage.getItem('token');
            }

            // Shuffle array utility function
            function shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            // Check user authentication
            function checkAuthentication() {
                const userToken = getUserToken();
                console.log('[v0] Token status:', userToken ? `Present (${userToken.substring(0, 10)}...)` : 'MISSING');
                
                if (!userToken) {
                    console.error('[v0] ❌ No user token found - user needs to sign in');
                    return false;
                }
                
                return true;
            }

            // Show loader
            function showLoader(message = 'Loading...') {
                elements.loader.querySelector('.loader-text').textContent = message;
                elements.loader.classList.remove('hidden');
                elements.mainContent.classList.add('hidden');
            }

            // Hide loader
            function hideLoader() {
                elements.loader.classList.add('hidden');
                elements.mainContent.classList.remove('hidden');
            }

            // Show unauthorized message
            function showUnauthorized() {
                elements.unauthorizedMessage.classList.remove('hidden');
                elements.quizContainer.classList.add('hidden');
                elements.resultContainer.classList.add('hidden');
            }

            // Fetch university name
            async function fetchUniversityName() {
                try {
                    const currentUserData = JSON.parse(localStorage.getItem('currentUserData') || '{}');
                    const currentUser = currentUserData.user;
                    if (!currentUser || !currentUser.university) return;
                    
                    const response = await fetch(`${API_BASE}/universities/all`);
                    if (!response.ok) return;

                    const data = await response.json();
                    const universities = data.data || data;

                    const userUniversity = universities.find(u => u._id === currentUser.university);
                    
                    if (userUniversity) {
                        const uniName = userUniversity.name || userUniversity.universityName || 'University';
                        elements.universityHeader.textContent = `${uniName.toUpperCase()} EXAMS SIMULATION`;
                    }
                } catch (error) {
                    console.error('[v0] Error fetching university name:', error);
                }
            }

            // Start CBT exam - Fetches questions and sets up state
            async function startCBTExam() {
                try {
                    showLoader('Starting exam...');
                    
                    const userToken = getUserToken();
                    if (!userToken) {
                        throw new Error('No authentication token found');
                    }

                    console.log('[v0] Starting CBT exam with POST request to:', `${API_BASE}/cbt/start`);
                    
                    const requestBody = {
                        courseId: state.courseId
                    };
                    
                    const response = await fetch(`${API_BASE}/cbt/start`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${userToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    console.log('[v0] Response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.log('[v0] Error response body:', errorText);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('[v0] CBT start response:', data);

                    // Extract CBT ID and questions from response
                    if (data.success && data.data) {
                        state.cbtId = data.data.cbtId || data.data._id;
                        let allQuestions = data.data.questions || [];
                        
                        // Limit to 35 questions maximum
                        const MAX_QUESTIONS = 35;
                        if (allQuestions.length > MAX_QUESTIONS) {
                            console.log(`[v0] Limiting questions from ${allQuestions.length} to ${MAX_QUESTIONS}`);
                            allQuestions = shuffleArray(allQuestions).slice(0, MAX_QUESTIONS);
                        }
                        
                        state.quizData = allQuestions;
                        
                        if (state.quizData.length === 0) {
                            throw new Error('No questions received from server');
                        }
                        
                        console.log('[v0] CBT ID:', state.cbtId);
                        console.log('[v0] Questions loaded:', state.quizData.length);
                        
                        hideLoader();
                        startQuiz();
                    } else {
                        throw new Error('Invalid response format from server');
                    }

                } catch (error) {
                    console.error('[v0] Error starting CBT exam:', error);
                    hideLoader();
                    showError(`Error starting exam: ${error.message}`);
                }
            }

            // Start the quiz
            function startQuiz() {
                state.isQuizActive = true;
                state.currentQuestionIndex = 0;
                state.selectedAnswers = {};
                
                elements.unauthorizedMessage.classList.add('hidden');
                elements.quizContainer.classList.remove('hidden');
                elements.resultContainer.classList.add('hidden');
                
                displayQuestion();
                startTimer();
                
                // Add event listeners (ensure they are only added once)
                elements.prevButton.onclick = previousQuestion;
                elements.nextButton.onclick = nextQuestion;
                elements.confirmSubmitButton.onclick = submitQuiz;
                elements.cancelSubmitButton.onclick = hideConfirmationDialog;
                elements.showAnswersButton.onclick = showAnswers;
                elements.restartButton.onclick = restartQuiz;
            }

            // Display current question
            function displayQuestion() {
                const questionData = state.quizData[state.currentQuestionIndex];
                if (!questionData) return;

                elements.questionElement.textContent = `${state.currentQuestionIndex + 1}. ${questionData.question || questionData.Q}`;
                
                elements.choicesElement.innerHTML = '';
                
                let formattedChoices = [];
                const choices = questionData.choices || questionData.options;

                // --- Logic to handle A-E options ---
                if (Array.isArray(choices)) {
                    formattedChoices = choices.map((choice, index) => {
                        const defaultLetter = String.fromCharCode(65 + index);
                        let text = String(choice);
                        let value = defaultLetter;

                        if (typeof choice === 'object' && choice !== null) {
                            text = choice.text || choice.option || choice.choice || choice.value || String(choice);
                            value = choice.value || choice.key || defaultLetter;
                        }
                        return { text, value };
                    }).filter(c => c.text !== 'undefined');
                } else if (typeof choices === 'object' && choices !== null) {
                    formattedChoices = Object.keys(choices).map(key => {
                        return { text: choices[key], value: key };
                    });
                } else {
                    const letters = ['A', 'B', 'C', 'D', 'E'];
                    formattedChoices = letters.map(letter => {
                        return { text: questionData[letter], value: letter };
                    }).filter(choice => choice.text);
                }
                // --- End A-E Logic ---

                if (formattedChoices.length === 0) {
                    elements.choicesElement.innerHTML = '<li style="color: red;">Error: No choices available for this question.</li>';
                } else {
                    formattedChoices.forEach((choice, index) => {
                        const li = document.createElement('li');
                        const label = document.createElement('label');
                        const input = document.createElement('input');
                        
                        input.type = 'radio';
                        input.name = 'answer';
                        input.value = String(choice.value);
                        input.id = `choice-${index}`;
                        
                        const questionId = questionData._id || questionData.id || state.currentQuestionIndex;
                        
                        if (state.selectedAnswers[questionId] === input.value) {
                            input.checked = true;
                        }
                        
                        input.addEventListener('change', () => {
                            state.selectedAnswers[questionId] = input.value;
                        });
                        
                        label.appendChild(input);
                        
                        let choiceTextContent = String(choice.text);
                        const choiceValue = String(choice.value);

                        if (!choiceTextContent.trim().startsWith(choiceValue + '.') && 
                            !choiceTextContent.trim().startsWith(choiceValue + ')') &&
                            /^[A-E]$/.test(choiceValue)) {
                             choiceTextContent = `${choiceValue}. ${choiceTextContent}`;
                        }

                        label.appendChild(document.createTextNode(" " + choiceTextContent));
                        li.appendChild(label);
                        elements.choicesElement.appendChild(li);
                    });
                }

                // Update navigation buttons
                elements.prevButton.disabled = state.currentQuestionIndex === 0;
                elements.nextButton.textContent = state.currentQuestionIndex === state.quizData.length - 1 ? 'Submit' : 'Next';
            }

            // Previous question
            function previousQuestion() {
                if (state.currentQuestionIndex > 0) {
                    state.currentQuestionIndex--;
                    displayQuestion();
                }
            }

            // Next question or submit
            function nextQuestion() {
                if (state.currentQuestionIndex < state.quizData.length - 1) {
                    state.currentQuestionIndex++;
                    displayQuestion();
                } else {
                    showConfirmationDialog();
                }
            }

            // Show confirmation dialog
            function showConfirmationDialog() {
                elements.confirmationDialog.classList.remove('hidden');
            }

            // Hide confirmation dialog
            function hideConfirmationDialog() {
                elements.confirmationDialog.classList.add('hidden');
            }

            // Submit quiz
            async function submitQuiz() {
                try {
                    hideConfirmationDialog();
                    showLoader('Submitting exam...');
                    
                    const userToken = getUserToken();
                    
                    if (!userToken) {
                        throw new Error('No authentication token found. Please sign in again.');
                    }

                    const answers = [];
                    state.quizData.forEach((question, index) => {
                        const questionId = question._id || question.id || index;
                        const selectedOption = state.selectedAnswers[questionId] || null;
                        
                        // Only add to answers array if question was answered
                        if (selectedOption) {
                            answers.push({
                                questionId: questionId,
                                selectedOption: selectedOption
                            });
                        }
                    });

                    console.log('[v0] Final Submission Payload:', {
                        cbtId: state.cbtId,
                        answers: answers
                    });

                    const response = await fetch(`${API_BASE}/cbt/submit`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${userToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            cbtId: state.cbtId,
                            answers: answers
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('[v0] Submission error:', { status: response.status, body: errorText });
                        
                        if (response.status === 401) {
                            localStorage.removeItem('token');
                            localStorage.removeItem('user');
                            localStorage.removeItem('currentUserData');
                            throw new Error('Authentication failed during submission. Please sign in again.');
                        } else {
                            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                        }
                    }

                    const data = await response.json();
                    console.log('[v0] SUCCESSFUL CBT SUBMISSION RESPONSE:', data);

                    hideLoader();
                    stopTimer();
                    showResults(data);

                } catch (error) {
                    console.error('[v0] Error submitting CBT:', error);
                    hideLoader();
                    
                    if (error.message.includes('sign in again')) {
                        showError(`${error.message}<br><br><a href="sign-in.html" class="btn" style="margin-top: 15px;">Sign In</a>`);
                    } else {
                        showError(`Error submitting exam: ${error.message}`);
                    }
                }
            }

            // Show results
            function showResults(data) {
                state.isQuizActive = false;
                elements.quizContainer.classList.add('hidden');
                elements.resultContainer.classList.remove('hidden');
                elements.timerElement.classList.add('hidden');

                const score = data.data?.score || data.score || 0;
                const totalQuestions = state.quizData.length; // Always use local quiz data length (35)
                const percentage = Math.round((score / totalQuestions) * 100);
                
                console.log('[v0] Results Debug:', {
                    scoreFromAPI: data.data?.score || data.score,
                    totalQuestions: totalQuestions,
                    calculatedPercentage: percentage,
                    fullResponse: data
                });
                
                elements.scoreElement.textContent = `Your Score: ${score}/${totalQuestions} (${percentage}%)`;

                elements.answersListElement.innerHTML = '';
                elements.showAnswersButton.classList.remove('hidden');
            }

            async function fetchDetailedResults() {
                try {
                    showLoader('Loading detailed results...');
                    
                    const userToken = getUserToken();
                    
                    if (!userToken) {
                        throw new Error('No authentication token found');
                    }

                    console.log('[v0] Fetching detailed results from:', `${API_BASE}/cbt/${state.cbtId}/results`);

                    const response = await fetch(`${API_BASE}/cbt/${state.cbtId}/results`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${userToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    console.log('[v0] API Response Status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('[v0] Error fetching results:', { status: response.status, body: errorText });
                        throw new Error(`Failed to load results: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('[v0] Detailed results API response:', data);

                    // Store the full response
                    state.detailedResults = data;
                    
                    hideLoader();
                    displayDetailedResults();

                } catch (error) {
                    console.error('[v0] Error fetching detailed results:', error);
                    hideLoader();
                    elements.answersListElement.innerHTML = `<li style="list-style: none; color: red;">Error loading results: ${error.message}</li>`;
                }
            }

            function displayDetailedResults() {
                elements.answersListElement.innerHTML = '';
                
                console.log('[v0] displayDetailedResults - state.detailedResults:', state.detailedResults);
                
                // Handle different possible API response formats
                let results = [];
                
                if (state.detailedResults) {
                    // Try different possible response structures
                    if (state.detailedResults.data && Array.isArray(state.detailedResults.data)) {
                        results = state.detailedResults.data;
                    } else if (state.detailedResults.data && state.detailedResults.data.results) {
                        results = state.detailedResults.data.results;
                    } else if (Array.isArray(state.detailedResults)) {
                        results = state.detailedResults;
                    } else if (state.detailedResults.results && Array.isArray(state.detailedResults.results)) {
                        results = state.detailedResults.results;
                    }
                }
                
                console.log('[v0] Parsed results array:', results);
                
                if (!results || results.length === 0) {
                    elements.answersListElement.innerHTML = '<li style="list-style: none; color: red;">No results data available. Please try again.</li>';
                    return;
                }

                results.forEach((result, index) => {
                    const li = document.createElement('li');
                    
                    // Determine if answer is correct
                    const isCorrect = result.isCorrect === true || result.correct === true;
                    li.classList.add(isCorrect ? 'correct' : 'incorrect');
                    
                    // Extract question text from various possible field names
                    const questionText = result.question || result.Q || result.questionText || `Question ${index + 1}`;
                    
                    // Extract user's answer from various possible field names
                    const submittedAnswer = result.userAnswer || result.selectedAnswer || result.userSelectedAnswer || 'Not Answered';
                    
                    // Extract correct answer from various possible field names
                    const correctAnswer = result.correctAnswer || result.Ans || 'N/A';
                    
                    console.log(`[v0] Question ${index + 1} debug:`, { questionText, submittedAnswer, correctAnswer, isCorrect });
                    
                    li.innerHTML = `
                        <strong>Q${index + 1}: ${questionText}</strong><br>
                        Your Answer: <span style="font-weight: bold; color: ${isCorrect ? '#4CAF50' : '#f44336'};">${submittedAnswer}</span><br>
                        Correct Answer: <span style="font-weight: bold; color: #4CAF50;">${correctAnswer}</span>
                        <br><span style="font-weight: 600; ${isCorrect ? 'color: #4CAF50;' : 'color: #f44336;'}">${isCorrect ? '✓ Correct' : '✗ Incorrect'}</span>
                    `;
                    
                    elements.answersListElement.appendChild(li);
                });
            }

            // Show answers
            function showAnswers() {
                const isCurrentlyHidden = elements.answersListElement.classList.contains('hidden');
                
                if (isCurrentlyHidden) {
                    // Fetch results from API
                    fetchDetailedResults();
                    elements.answersListElement.classList.remove('hidden');
                    elements.showAnswersButton.textContent = 'Hide Answers';
                } else {
                    elements.answersListElement.classList.add('hidden');
                    elements.showAnswersButton.textContent = 'Show Answers';
                }
            }

            // Restart quiz
            function restartQuiz() {
                if (confirm('Are you sure you want to restart the exam?')) {
                    location.reload();
                }
            }

            // Load test data for exams mode
            function loadTestExamData() {
                console.log('[v0] Loading test exam data...');
                
                const testQuestions = [];
                const sampleQuestions = [
                    {
                        _id: "test1", Q: "The Yoruba believe that life started in?", A: "Ile-Ife", B: "Oyo", C: "Benin", D: "Lagos", E: "Kaduna", Ans: "A"
                    },
                    {
                        _id: "test2", Q: "___ is the practice of resolving differences in a manner prescribed by society as opposed to creating conflict.", A: "Negotiation", B: "Conflict Resolution", C: "Mediation", D: "Arbitration", E: "Debate", Ans: "B"
                    },
                    {
                        _id: "test3", Q: "What is the pH of pure water at 25°C?", A: "6", B: "7", C: "8", D: "9", Ans: "B"
                    },
                    {
                        _id: "test4", Q: "Which gas makes up about 78% of Earth's atmosphere?", A: "Oxygen", B: "Carbon dioxide", C: "Nitrogen", D: "Argon", Ans: "C"
                    },
                    {
                        _id: "test5", Q: "What is the molecular formula for methane?", A: "CH4", B: "C2H6", C: "C3H8", D: "C4H10", Ans: "A"
                    }
                ];
                
                for (let i = 0; i < 35; i++) {
                    const baseQuestion = sampleQuestions[i % sampleQuestions.length];
                    testQuestions.push({
                        ...baseQuestion,
                        _id: `test-${i}`,
                        Ans: baseQuestion.Ans
                    });
                }
                
                state.quizData = testQuestions;
                state.cbtId = 'test-exam-' + Date.now();
                
                state.quizData.forEach(q => {
                    const questionId = q._id;
                    const submittedAnswer = (parseInt(questionId.split('-')[1]) % 3 === 0) ? (q.Ans === 'A' ? 'B' : 'A') : q.Ans;
                    state.selectedAnswers[questionId] = submittedAnswer;
                });
                
                generateLocalResultsAndShow();
            }

            // Generate local results for fallback
            function generateLocalResultsAndShow() {
                console.warn('[v0] Generating local results for display/fallback.');
                
                let score = 0;
                const localResults = [];

                state.quizData.forEach((question, index) => {
                    const questionId = question._id || question.id || index;
                    const submittedAnswer = state.selectedAnswers[questionId];
                    const correctAnswer = question.Ans;

                    const isCorrect = submittedAnswer === correctAnswer;
                    if (isCorrect) {
                        score++;
                    }

                    localResults.push({
                        questionId: questionId,
                        isCorrect: isCorrect,
                        correctAnswer: correctAnswer || 'N/A',
                        submittedAnswer: submittedAnswer || 'N/A'
                    });
                });

                const localData = {
                    data: {
                        score: score,
                        results: localResults
                    }
                };

                hideLoader();
                stopTimer();
                showResults(localData);
            }

            // Show error
            function showError(message) {
                hideLoader();
                elements.mainContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #fff; margin-bottom: 20px;">Error</h3>
                        <p style="color: #eee; margin-bottom: 30px;">${message}</p>
                        <button onclick="location.reload()" class="btn">Try Again</button>
                        <button onclick="window.location.href='quiz.html?courseId=${state.courseId}&courseCode=${state.courseCode}'" class="btn" style="margin-left: 10px;">Back to Quiz</button>
                        
                        <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <h4 style="color: #fff; margin-bottom: 15px;">Test Mode Available</h4>
                            <p style="color: #eee; margin-bottom: 15px;">If the API is giving errors, you can test the exam functionality with sample data (35 questions):</p>
                            <button onclick="window.loadTestExamData()" class="btn" style="background-color: #28a745;">Load Test Exam</button>
                        </div>
                    </div>
                `;
            }
            
            // Make loadTestExamData globally accessible
            window.loadTestExamData = loadTestExamData;

            // Initialize the application
            async function initApp() {
                try {
                    getUrlParams();
                    
                    if (!state.courseId || !state.courseCode) {
                        throw new Error('Missing course information. Please select a course from the quiz page.');
                    }

                    showLoader('Checking authorization...');
                    
                    fetchUniversityName();
                    
                    if (!checkAuthentication()) {
                        hideLoader();
                        showUnauthorized();
                        return;
                    }

                    await startCBTExam();

                } catch (error) {
                    console.error('[v0] Initialization error:', error);
                    showError(error.message);
                }
            }

            // Start the application
            initApp();
        });
    </script>
</body>
</html>
