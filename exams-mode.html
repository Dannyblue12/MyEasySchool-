<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKSU EXAMS SIMULATION - CBT</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for appearance */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f0fdf4; /* Light Green/White background */
        }
        .main-bg {
            background-color: #059669; /* Emerald 600 - Primary Green */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .text-primary {
            color: #059669; /* Emerald 600 */
        }
        .btn-primary {
            background-color: #1E1E4D; /* Deep Blue from original */
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2a2a6a;
        }
        .btn-submit {
            background-color: #dc2626; /* Red for Submit/Danger */
        }
        .btn-submit:hover:not(:disabled) {
            background-color: #b91c1c;
        }
        /* Custom Radio Button Styling */
        input[type="radio"] {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
            font: inherit;
            width: 1.15em;
            height: 1.15em;
            border: 0.15em solid #059669;
            border-radius: 50%;
            transform: translateY(-0.075em);
            display: grid;
            place-content: center;
            cursor: pointer;
            flex-shrink: 0; /* Prevents shrinking in flex layout */
        }

        input[type="radio"]::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            border-radius: 50%;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #1E1E4D;
        }

        input[type="radio"]:checked::before {
            transform: scale(1);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Loader Screen -->
    <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-emerald-600 transition-opacity duration-500">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-white h-12 w-12 mb-4 animate-spin"></div>
        <p class="loader-text text-white text-xl font-semibold">Checking authorization...</p>
    </div>

    <!-- Header -->
    <header class="main-bg text-white p-4 text-center">
        <h1 id="universityHeader" class="text-2xl sm:text-3xl font-extrabold tracking-wider">AKSU EXAMS SIMULATION</h1>
        <h3 id="courseHeader" class="text-xl font-light opacity-90 mt-1">CBT</h3>
    </header>

    <!-- Timer (Hidden until quiz starts) -->
    <div id="timer" class="hidden text-right p-2 pr-4 bg-yellow-50 text-red-600 font-extrabold text-xl shadow-md">
        Time Left:
        <span id="countdownHours">00</span>:
        <span id="countdownMinutes">00</span>:
        <span id="countdownSeconds">00</span>
    </div>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-grow p-4 sm:p-6 lg:p-8">
        <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">

            <!-- Unauthorized Message -->
            <section id="unauthorized-message" class="hidden text-center py-12">
                <h2 class="text-3xl font-bold text-red-600 mb-4">Access Required</h2>
                <p class="text-gray-600 mb-6">You must be signed in to access the exam mode.</p>
                <a href="sign-in.html" class="btn-primary inline-block px-6 py-3 rounded-lg font-semibold shadow-md hover:shadow-lg">Sign In Now</a>
            </section>

            <!-- Quiz Container -->
            <section id="quiz-container" class="hidden">
                <p class="text-sm text-gray-500 mb-2">Question <span id="current-q-num">1</span> of <span id="total-q-num">0</span></p>
                <div class="border-b border-gray-200 pb-4 mb-6">
                    <p id="question" class="text-xl font-medium text-gray-800"></p>
                </div>
                
                <ul id="choices" class="space-y-4">
                    <!-- Choices will be injected here -->
                </ul>
                
                <div class="navigation-buttons flex justify-between mt-8 pt-4 border-t border-gray-100">
                    <button id="prev-btn" class="btn-primary px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                    <button id="next-btn" class="btn-primary px-6 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                </div>
            </section>

            <!-- Result Container -->
            <div id="result-container" class="hidden text-center">
                <h2 class="text-4xl font-extrabold text-primary mb-6">Exam Complete!</h2>
                <p id="score" class="text-3xl font-bold text-gray-800 mb-4"></p>
                <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4 mb-8">
                    <button id="show-answers-btn" class="btn-primary px-6 py-3 rounded-lg shadow-md">Show Detailed Review</button>
                    <button id="restart-btn" class="btn-primary bg-gray-500 hover:bg-gray-600 px-6 py-3 rounded-lg shadow-md">Restart Exam</button>
                </div>

                <div id="review-section" class="mt-8">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Review Answers</h3>
                    <ul id="answers-list" class="hidden text-left space-y-3">
                        <!-- Detailed answers injected here -->
                    </ul>
                </div>
            </div>
            
            <!-- Error Message Container (Custom Modal/In-page) -->
            <div id="error-message-box" class="hidden text-center py-12">
                <h3 class="text-3xl font-bold text-red-600 mb-4">An Error Occurred</h3>
                <p id="error-text" class="text-gray-600 mb-6"></p>
                <button onclick="window.location.reload()" class="btn-primary px-6 py-3 rounded-lg shadow-md">Try Reloading</button>
            </div>
        </div>
    </main>
    
    <!-- Confirmation Dialog (Modal) -->
    <div id="confirmation-dialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm w-full">
            <p class="text-xl font-semibold text-gray-800 mb-6">Are you sure you want to submit the exam?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-submit" class="btn-primary bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg">Yes, Submit</button>
                <button id="cancel-submit" class="btn-primary bg-gray-500 hover:bg-gray-600 px-6 py-2 rounded-lg">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // --- CONSTANTS & STATE ---
            const API_BASE = "https://my-easy-school-api.onrender.com/api";
            const EXAM_DURATION = 900; // 15 minutes in seconds

            const state = {
                quizData: [],
                currentQuestionIndex: 0,
                selectedAnswers: {}, // { questionId: "A", ... }
                timeLeft: EXAM_DURATION,
                timerInterval: null,
                isQuizActive: false,
                courseId: null,
                courseCode: null,
                cbtId: null
            };
            
            // --- DOM ELEMENTS MAPPING ---
            const elements = {
                loader: document.getElementById('loader'),
                mainContent: document.getElementById('main-content'),
                unauthorizedMessage: document.getElementById('unauthorized-message'),
                quizContainer: document.getElementById('quiz-container'),
                resultContainer: document.getElementById('result-container'),
                questionElement: document.getElementById('question'),
                choicesElement: document.getElementById('choices'),
                prevButton: document.getElementById('prev-btn'),
                nextButton: document.getElementById('next-btn'),
                scoreElement: document.getElementById('score'),
                showAnswersButton: document.getElementById('show-answers-btn'),
                restartButton: document.getElementById('restart-btn'),
                timerElement: document.getElementById('timer'),
                answersListElement: document.getElementById('answers-list'),
                confirmationDialog: document.getElementById('confirmation-dialog'),
                confirmSubmitButton: document.getElementById('confirm-submit'),
                cancelSubmitButton: document.getElementById('cancel-submit'),
                countdownHours: document.getElementById('countdownHours'),
                countdownMinutes: document.getElementById('countdownMinutes'),
                countdownSeconds: document.getElementById('countdownSeconds'),
                courseHeader: document.getElementById('courseHeader'),
                universityHeader: document.getElementById('universityHeader'),
                currentQNum: document.getElementById('current-q-num'),
                totalQNum: document.getElementById('total-q-num'),
                errorMessageBox: document.getElementById('error-message-box'),
                errorText: document.getElementById('error-text')
            };

            // --- API HELPER FUNCTIONS ---
            
            function getUserToken() {
                return localStorage.getItem('token');
            }

            /**
             * Centralized function for API calls, handling auth and error logging.
             */
            async function makeApiCall(endpoint, method = 'GET', body = null) {
                const userToken = getUserToken();
                const url = `${API_BASE}${endpoint}`;

                if (endpoint.startsWith('/cbt') && !userToken) {
                    throw new Error('Authentication token missing.');
                }

                const headers = {
                    'Content-Type': 'application/json',
                };
                if (userToken) {
                    headers['Authorization'] = `Bearer ${userToken}`;
                }

                try {
                    console.log(`[API] Making ${method} request to: ${endpoint}`);
                    const response = await fetch(url, {
                        method: method,
                        headers: headers,
                        body: body ? JSON.stringify(body) : null
                    });

                    if (response.status === 401) {
                        // Global 401 handler (like an axios interceptor)
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        localStorage.removeItem('currentUserData');
                        throw new Error('Unauthorized. Session expired. Please sign in again.');
                    }
                    
                    if (!response.ok) {
                         const errorText = await response.text();
                         console.error(`[API] HTTP Error ${response.status}:`, errorText);
                         // Attempt to parse JSON error message, otherwise return plain text
                         try {
                            const errorJson = JSON.parse(errorText);
                            throw new Error(errorJson.message || errorJson.error || `HTTP error ${response.status}`);
                         } catch {
                            throw new Error(`HTTP error ${response.status}: ${errorText.substring(0, 100)}...`);
                         }
                    }

                    const data = await response.json();
                    console.log(`[API] Success response from ${endpoint}:`, data);
                    return data;

                } catch (error) {
                    console.error(`[API] Call to ${endpoint} failed:`, error);
                    throw error; // Re-throw the handled error for the caller to process
                }
            }
            
            // --- UI/STATE HANDLERS ---
            
            function showLoader(message = 'Loading...') {
                elements.loader.querySelector('.loader-text').textContent = message;
                elements.loader.classList.remove('opacity-0', 'pointer-events-none', 'hidden');
            }

            function hideLoader() {
                elements.loader.classList.add('hidden');
            }

            function showUnauthorized() {
                elements.unauthorizedMessage.classList.remove('hidden');
            }
            
            function getUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                state.courseId = urlParams.get('courseId');
                state.courseCode = urlParams.get('courseCode');
                
                if (state.courseCode) {
                    elements.courseHeader.textContent = `${state.courseCode} CBT`;
                }
            }

            async function fetchUniversityName() {
                try {
                    const currentUserData = JSON.parse(localStorage.getItem('currentUserData') || '{}');
                    const currentUser = currentUserData.user;
                    if (!currentUser || !currentUser.university) return;
                    
                    const data = await makeApiCall('/universities/all');
                    
                    const universities = data.data || data;

                    const userUniversity = universities.find(u => u._id === currentUser.university);
                    
                    if (userUniversity) {
                        const uniName = userUniversity.name || userUniversity.universityName || 'University';
                        elements.universityHeader.textContent = `${uniName.toUpperCase()} EXAMS SIMULATION`;
                    }
                } catch (error) {
                    console.error('[v0] Error fetching university name:', error);
                    // Do not fail initialization over this minor display error
                }
            }
            
            // --- QUIZ FLOW LOGIC ---

            async function startCBTExam() {
                try {
                    showLoader('Starting exam and fetching questions...');
                    
                    const requestBody = {
                        courseId: state.courseId,
                        // No need for numberOfQuestions, server defaults to MAX or all
                    };
                    
                    const data = await makeApiCall('/cbt/start', 'POST', requestBody);
                    
                    // The API response is expected to be { success: true, data: { cbtId, questions } }
                    if (data.success && data.data) {
                        state.cbtId = data.data.cbtId || data.data._id;
                        let allQuestions = data.data.questions || [];
                        
                        // Client-side question limit (matching the old logic)
                        const MAX_QUESTIONS = 35; 
                        if (allQuestions.length > MAX_QUESTIONS) {
                            console.log(`[CBT] Limiting questions from ${allQuestions.length} to ${MAX_QUESTIONS}`);
                            // Randomize and slice
                            const shuffled = allQuestions.sort(() => 0.5 - Math.random());
                            state.quizData = shuffled.slice(0, MAX_QUESTIONS);
                        } else {
                            state.quizData = allQuestions;
                        }

                        if (state.quizData.length === 0) {
                            throw new Error('No questions available for this course.');
                        }
                        
                        console.log(`[CBT] Exam ID: ${state.cbtId}. Questions loaded: ${state.quizData.length}`);
                        
                        startQuiz();
                        hideLoader();
                    } else {
                        throw new Error('Invalid response format when starting exam.');
                    }

                } catch (error) {
                    console.error('[CBT] Error starting CBT exam:', error);
                    showError(`Failed to start exam: ${error.message}`);
                }
            }

            function startQuiz() {
                state.isQuizActive = true;
                state.currentQuestionIndex = 0;
                
                elements.unauthorizedMessage.classList.add('hidden');
                elements.quizContainer.classList.remove('hidden');
                elements.resultContainer.classList.add('hidden');
                elements.errorMessageBox.classList.add('hidden');
                
                displayQuestion();
                startTimer();
                
                // Set up event listeners (once)
                elements.prevButton.onclick = previousQuestion;
                elements.nextButton.onclick = nextQuestion;
                elements.confirmSubmitButton.onclick = submitQuiz;
                elements.cancelSubmitButton.onclick = hideConfirmationDialog;
                elements.showAnswersButton.onclick = showAnswers;
                elements.restartButton.onclick = restartQuiz;

                elements.totalQNum.textContent = state.quizData.length;
            }

            function displayQuestion() {
                const q = state.quizData[state.currentQuestionIndex];
                if (!q) return;

                const questionId = q._id || q.id;
                
                elements.currentQNum.textContent = state.currentQuestionIndex + 1;

                elements.questionElement.textContent = `${state.currentQuestionIndex + 1}. ${q.question || q.Q}`;
                elements.choicesElement.innerHTML = '';
                
                const choicesMap = {};
                // The API can return options as a simple array or an object (A, B, C...)
                const options = q.choices || q.options;

                if (Array.isArray(options)) {
                    // Handle array of strings/objects
                    options.forEach((choice, index) => {
                        const letter = String.fromCharCode(65 + index);
                        let text = String(choice);
                        let value = letter;
                        
                        if (typeof choice === 'object' && choice !== null) {
                            text = choice.text || choice.option || choice.choice || choice.value || String(choice);
                            value = choice.value || choice.key || letter;
                        }
                        choicesMap[value] = text;
                    });
                } else if (typeof options === 'object' && options !== null) {
                    // Handle object of key-value pairs
                    Object.assign(choicesMap, options);
                } else {
                    // Fallback to checking A, B, C, D properties directly
                    ['A', 'B', 'C', 'D', 'E'].forEach(letter => {
                        if (q[letter]) {
                            choicesMap[letter] = q[letter];
                        }
                    });
                }

                Object.keys(choicesMap).forEach((value, index) => {
                    const text = choicesMap[value];
                    const li = document.createElement('li');
                    const label = document.createElement('label');
                    label.className = 'flex items-start p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition duration-150';

                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = 'answer';
                    input.value = value;
                    input.id = `choice-${index}`;
                    input.className = 'mt-1 mr-3';
                    
                    if (state.selectedAnswers[questionId] === value) {
                        input.checked = true;
                    }
                    
                    input.addEventListener('change', () => {
                        state.selectedAnswers[questionId] = value;
                    });
                    
                    label.appendChild(input);
                    
                    const textNode = document.createElement('span');
                    textNode.textContent = `${value}. ${text}`;
                    textNode.className = 'text-gray-700 font-medium';
                    
                    label.appendChild(textNode);
                    li.appendChild(label);
                    elements.choicesElement.appendChild(li);
                });

                // Update navigation buttons
                elements.prevButton.disabled = state.currentQuestionIndex === 0;
                elements.nextButton.textContent = state.currentQuestionIndex === state.quizData.length - 1 ? 'Submit' : 'Next';
                
                // Change button style for Submit
                if (state.currentQuestionIndex === state.quizData.length - 1) {
                    elements.nextButton.classList.add('btn-submit');
                    elements.nextButton.classList.remove('btn-primary');
                } else {
                    elements.nextButton.classList.add('btn-primary');
                    elements.nextButton.classList.remove('btn-submit');
                }
            }

            function previousQuestion() {
                if (state.currentQuestionIndex > 0) {
                    state.currentQuestionIndex--;
                    displayQuestion();
                }
            }

            function nextQuestion() {
                if (state.currentQuestionIndex < state.quizData.length - 1) {
                    state.currentQuestionIndex++;
                    displayQuestion();
                } else {
                    showConfirmationDialog();
                }
            }

            function showConfirmationDialog() {
                elements.confirmationDialog.classList.remove('hidden');
            }

            function hideConfirmationDialog() {
                elements.confirmationDialog.classList.add('hidden');
            }

            async function submitQuiz() {
                try {
                    hideConfirmationDialog();
                    stopTimer();
                    showLoader('Submitting exam and grading...');
                    
                    // Prepare answers array
                    const answers = state.quizData.map(q => {
                        const questionId = q._id || q.id;
                        const answer = state.selectedAnswers[questionId];
                        
                        return {
                            questionId: questionId,
                            answer: answer || '' // Send empty string if no answer provided
                        };
                    });
                    
                    const requestBody = {
                        cbtId: state.cbtId,
                        answers: answers
                    };

                    const data = await makeApiCall('/cbt/submit', 'POST', requestBody);
                    
                    // The successful response is expected to contain the score and results array
                    if (data.success && data.data) {
                        hideLoader();
                        showResults(data.data);
                    } else {
                        // Handle cases where the submission was successful but data format is unexpected
                        throw new Error("Submission successful, but unable to read grade data. Check console for raw response.");
                    }

                } catch (error) {
                    console.error('[CBT] Error submitting CBT:', error);
                    hideLoader();
                    
                    if (error.message.includes('sign in again')) {
                        // Redirect if unauthorized
                        showError(`${error.message} <br><a href="sign-in.html" class="btn-primary mt-4 inline-block px-4 py-2 rounded-lg">Sign In</a>`);
                    } else {
                        // Provide option to reload or retry
                        showError(`Error submitting exam: ${error.message}`);
                    }
                }
            }

            function showResults(data) {
                state.isQuizActive = false;
                elements.quizContainer.classList.add('hidden');
                elements.resultContainer.classList.remove('hidden');
                elements.timerElement.classList.add('hidden');
                elements.errorMessageBox.classList.add('hidden');

                // Data format expected: { score: number, results: [{ questionId, isCorrect, correctAnswer, submittedAnswer }] }
                const score = data.score || 0;
                const results = data.results || [];
                const totalQuestions = state.quizData.length;
                const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
                
                elements.scoreElement.innerHTML = `You answered <span class="text-primary">${score}</span> correctly out of ${totalQuestions} questions.<br>
                                                   Final Score: <span class="text-primary font-extrabold">${percentage}%</span>`;

                // Map original questions by ID for easy lookup
                const quizMap = new Map(state.quizData.map(q => [q._id || q.id, q]));

                elements.answersListElement.innerHTML = '';
                
                if (results.length > 0) {
                    results.forEach((result, index) => {
                        const questionIdentifier = result.questionId;
                        const originalQuestion = quizMap.get(questionIdentifier);
                        
                        if (!originalQuestion) return;

                        const li = document.createElement('li');
                        li.className = `p-4 rounded-lg shadow-sm transition-all duration-300 ${result.isCorrect ? 'bg-green-50 border-l-4 border-green-500' : 'bg-red-50 border-l-4 border-red-500'}`;
                        
                        const questionText = originalQuestion.question || originalQuestion.Q;
                        const submittedAnswer = result.submittedAnswer || state.selectedAnswers[questionIdentifier] || 'Not Answered';
                        const correctAnswer = result.correctAnswer || 'Unknown';
                        
                        li.innerHTML = `
                            <p class="font-bold text-gray-800 mb-2">Q${index + 1}: ${questionText}</p>
                            <p class="text-sm">Your Answer: <span class="font-semibold">${submittedAnswer}</span></p>
                            <p class="text-sm">Correct Answer: <span class="font-semibold ${result.isCorrect ? 'text-green-600' : 'text-red-600'}">${correctAnswer}</span></p>
                        `;
                        
                        elements.answersListElement.appendChild(li);
                    });
                    
                    elements.showAnswersButton.classList.remove('hidden');
                } else {
                    elements.answersListElement.innerHTML = `<li class="p-4 text-center text-gray-500">Detailed answers are unavailable from the server.</li>`;
                    elements.showAnswersButton.classList.add('hidden');
                }
            }

            // --- TIMER LOGIC ---
            
            function startTimer() {
                elements.timerElement.classList.remove('hidden');
                elements.timerElement.classList.add('flex');
                
                state.timerInterval = setInterval(() => {
                    state.timeLeft--;
                    
                    const hours = Math.floor(state.timeLeft / 3600);
                    const minutes = Math.floor((state.timeLeft % 3600) / 60);
                    const seconds = state.timeLeft % 60;
                    
                    elements.countdownHours.textContent = hours.toString().padStart(2, '0');
                    elements.countdownMinutes.textContent = minutes.toString().padStart(2, '0');
                    elements.countdownSeconds.textContent = seconds.toString().padStart(2, '0');
                    
                    if (state.timeLeft <= 0) {
                        stopTimer();
                        submitQuiz();
                    }
                    
                    // High alert for last minute
                    if (state.timeLeft <= 60 && !elements.timerElement.classList.contains('bg-red-100')) {
                        elements.timerElement.classList.add('bg-red-100');
                    }
                }, 1000);
            }

            function stopTimer() {
                if (state.timerInterval) {
                    clearInterval(state.timerInterval);
                    state.timerInterval = null;
                }
            }

            function showAnswers() {
                const isHidden = elements.answersListElement.classList.toggle('hidden');
                elements.showAnswersButton.textContent = isHidden ? 'Show Detailed Review' : 'Hide Detailed Review';
            }

            function restartQuiz() {
                // Using custom modal logic, but for simplicity here, using native confirm as a last resort
                if (confirm('Are you sure you want to restart the exam? Your current progress will be lost.')) {
                    location.reload();
                }
            }
            
            function showError(message) {
                hideLoader();
                elements.quizContainer.classList.add('hidden');
                elements.resultContainer.classList.add('hidden');
                elements.unauthorizedMessage.classList.add('hidden');
                elements.timerElement.classList.add('hidden');
                elements.errorMessageBox.classList.remove('hidden');
                elements.errorText.innerHTML = message;
            }
            
            // --- INITIALIZATION ---
            async function initApp() {
                try {
                    showLoader('Starting up...');
                    getUrlParams();
                    
                    if (!state.courseId || !state.courseCode) {
                        throw new Error('Missing course information. Please navigate from the main quiz/course selection page.');
                    }

                    fetchUniversityName();
                    
                    if (!getUserToken()) {
                        hideLoader();
                        showUnauthorized();
                        return;
                    }

                    await startCBTExam();

                } catch (error) {
                    console.error('[CBT] Initialization error:', error);
                    showError(error.message);
                }
            }

            // Start the application
            initApp();
        });
    </script>
</body>
</html>
