<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <link rel="icon" type="image/jpeg" href="WhatsApp Image 2025-07-06 at 09.14.34_436c71fc.jpg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&display=swap');
        
        :root {
            --bg-color: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-muted: #9ca3af;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --accent-green: #22c55e;
            --accent-orange: #ff8c42;
            --surface-light: #f8f9fa;
            --calendar-bg: #ffffff;
            --calendar-border: #e5e7eb;
            --calendar-text: #1a1a1a;
            --calendar-muted: #9ca3af;
            --calendar-gray: #f3f4f6;
            --calendar-current-bg: rgba(34, 197, 94, 0.1);
            --calendar-current-border: #22c55e;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --card-bg: #1e293b;
            --border-color: #334155;
            --shadow-light: rgba(0, 0, 0, 0.3);
            --shadow-medium: rgba(0, 0, 0, 0.5);
            --surface-light: #334155;
            --calendar-bg: #1e293b;
            --calendar-border: #334155;
            --calendar-text: #f1f5f9;
            --calendar-muted: #64748b;
            --calendar-gray: #374151;
            --calendar-current-bg: rgba(34, 197, 94, 0.15);
            --calendar-current-border: #22c55e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .viewport {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .main-container {
            position: relative;
            width: 400%;
            height: 100%;
            display: flex;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .page {
            width: 25%;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            padding-bottom: 100px;
            scroll-behavior: smooth;
        }

        .page::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        /* Header Section */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 35px;
            padding-top: 10px;
        }

        .greeting {
            flex: 1;
        }

        .greeting h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .greeting p {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .avatar {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            border: 3px solid var(--accent-green);
            overflow: hidden;
            margin-left: 20px;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Weekly Calendar */
        .calendar-section {
            margin-bottom: 40px;
            position: relative;
        }

        .calendar-container {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 15px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
            touch-action: pan-x;
        }

        .calendar-container::-webkit-scrollbar {
            display: none;
        }

        .calendar {
            display: flex;
            gap: 12px;
            min-width: max-content;
            padding: 0 5px;
        }

        .day-card {
            background: var(--surface-light);
            border-radius: 50px;
            padding: 25px 16px;
            min-width: 85px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 2px 8px var(--shadow-light);
            height: 115px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .day-card.current {
            background: rgba(34, 197, 94, 0.1);
            border-color: var(--accent-green);
        }

        .day-card.completed {
            background: var(--surface-light);
        }

        .day-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-light);
        }

        .day-name {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-date-circle {
            width: 40px;
            height: 40px;
            background: var(--card-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            box-shadow: 0 2px 8px var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .day-card.current .day-date-circle {
            background: var(--card-bg);
            border-color: var(--accent-green);
        }

        /* Orange color for completed streaks */
        .day-card.completed .day-date-circle {
            background: var(--accent-orange) !important;
            border-color: var(--accent-orange) !important;
        }

        /* White text for completed streaks */
        .day-card.completed .date-number {
            color: white !important;
            font-weight: 700;
        }

        /* Current day with completed streak should be orange, not green - higher specificity */
        .day-card.current.completed,
        .day-card.completed.current {
            background: var(--surface-light) !important;
            border-color: transparent !important;
            border: 1px solid transparent !important;
        }

        .day-card.current.completed .day-date-circle,
        .day-card.completed.current .day-date-circle {
            background: var(--accent-orange) !important;
            border-color: var(--accent-orange) !important;
            border: 1px solid var(--accent-orange) !important;
        }

        .day-card.current.completed .date-number,
        .day-card.completed.current .date-number {
            color: white !important;
            font-weight: 700;
        }

        .date-number {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .day-card.current .date-number {
            color: var(--text-primary);
        }

        .day-card.completed .date-number {
            color: #ffffff;
        }

        .scroll-indicator {
            width: 80px;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 15px auto 0;
            position: relative;
            overflow: hidden;
        }

        .scroll-indicator-thumb {
            position: absolute;
            left: 0;
            top: 0;
            width: 30%;
            height: 100%;
            background: var(--text-muted);
            border-radius: 2px;
            transition: left 0.3s ease;
        }

        /* Courses Section */
        .courses-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .course-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 0;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 2px 12px var(--shadow-light);
            position: relative;
            cursor: pointer;
        }

        .course-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px var(--shadow-medium);
            border-color: var(--accent-green);
        }

        .course-image-placeholder {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, var(--surface-light) 0%, var(--border-color) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .course-image-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .course-content {
            padding: 18px;
            position: relative;
        }

        .course-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .course-code {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .course-schedule-indicator {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(34, 197, 94, 0.1);
            color: var(--accent-green);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .course-card.scheduled .course-schedule-indicator {
            opacity: 1;
            transform: translateY(0);
        }

        /* Videos Page */
        .videos-page {
            padding-top: 30px;
            position: relative;
        }

        .video-section {
            margin-bottom: 35px;
        }

        .video-section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-left: 5px;
        }

        .video-card {
            background: var(--card-bg);
            border-radius: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 4px 20px var(--shadow-light);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .video-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--shadow-medium);
            border-color: var(--accent-green);
        }

        .video-thumbnail {
            width: 100%;
            height: 220px;
            background: var(--surface-light);
            position: relative;
            overflow: hidden;
        }

        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.3s ease;
        }

        .play-button svg {
            width: 24px;
            height: 24px;
            margin-left: 3px;
        }

        .video-card:hover .play-button {
            background: var(--accent-green);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .video-info {
            padding: 20px;
        }

        .video-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .video-duration {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Streaks Page */
        .streaks-page {
            padding-top: 50px;
            text-align: center;
            position: relative;
            overflow-y: auto;
        }

        .streak-container {
            position: relative;
            margin-bottom: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .streak-glow {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255, 140, 66, 0.3) 0%, rgba(255, 140, 66, 0.1) 40%, transparent 70%);
            border-radius: 50%;
            animation: pulse 3s ease-in-out infinite;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.8s ease;
        }

         .streak-fire {
            width: 320px;
            height: 320px;
            position: relative;
            z-index: 2;
        }

        .streak-fire img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 15px 40px rgba(255, 140, 66, 0.4));
        }

        .streak-number {
            font-size: 72px;
            font-weight: 900;
            color: var(--accent-orange);
            margin-bottom: 20px;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s ease;
            text-shadow: 0 4px 20px rgba(255, 140, 66, 0.3);
        }

        .streak-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 50px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s ease;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .streak-calendar {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin: 30px 0;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px var(--shadow-light);
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s ease;
        }

        .streak-calendar-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .calendar-month-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .calendar-days-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .calendar-day-header {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            padding: 8px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        /* Updated calendar day styling to use circles instead of squares */
        .calendar-day {
            width: 40px;
            height: 40px;
            background: var(--card-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            box-shadow: 0 2px 8px var(--shadow-light);
            border: 1px solid var(--border-color);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .calendar-day.empty {
            cursor: default;
            background: transparent;
            box-shadow: none;
            border: none;
        }

        .calendar-day.current {
            background: var(--card-bg);
            border-color: var(--accent-green);
        }

        .calendar-day.completed {
            background: var(--accent-orange);
            border-color: var(--accent-orange);
            color: white;
            font-weight: 700;
        }

        /* Current day with completed streak should be orange, not green */
        .calendar-day.current.completed {
            background: var(--accent-orange);
            border-color: var(--accent-orange);
            color: white;
            font-weight: 700;
        }

        .calendar-day.future {
            color: var(--text-muted);
            background: var(--surface-light);
        }

        .calendar-day.past {
            color: var(--text-secondary);
            background: var(--surface-light);
        }

        .calendar-day:hover:not(.empty) {
            transform: scale(1.1);
            box-shadow: 0 4px 12px var(--shadow-medium);
        }

        /* Schedule Section */
        .schedule-section {
            margin-top: 40px;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s ease;
        }

        .schedule-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .schedule-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .schedule-course {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .schedule-course:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-medium);
        }

        .schedule-course-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .schedule-control-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #28a745;
            background: white;
            color: #28a745;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .schedule-control-btn:hover {
            background: #28a745;
            color: white;
            transform: scale(1.1);
        }

        .schedule-control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .schedule-control-btn:disabled:hover {
            background: white;
            color: #28a745;
        }

        .schedule-course-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .schedule-course-day {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .schedule-set-btn {
            width: 100%;
            background: var(--surface-light);
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: not-allowed;
            transition: all 0.3s ease;
        }

        .schedule-set-btn.active {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
            cursor: pointer;
        }

        .schedule-set-btn.active:hover {
            background: #16a34a;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
        }

        .schedule-locked-message {
            text-align: center;
            padding: 40px 20px;
        }

        .schedule-locked-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 12px;
        }

        .schedule-locked-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* Profile Page */
        .profile-page {
            padding-top: 30px;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--accent-green);
            overflow: hidden;
            margin: 0 auto 20px;
            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.2);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .analytics-section {
            margin-bottom: 40px;
        }

        .analytics-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 25px;
        }

        .analytics-grid {
            display: grid;
            gap: 16px;
        }

        .analytics-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 12px var(--shadow-light);
        }

        .analytics-subject {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .analytics-score {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 12px;
        }

        .analytics-progress {
            width: 100%;
            height: 8px;
            background: var(--surface-light);
            border-radius: 4px;
            overflow: hidden;
        }

        .analytics-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green) 0%, #16a34a 100%);
            border-radius: 4px;
            transition: width 0.8s ease;
        }
        .subscribe-info {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            text-align: left;
            gap: 16px;
            width: 100%;
        }

        .subscribe-info h4 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.4;
            flex: 1;
        }

        #currency {
            font-size: 20px;
            font-weight: 500;
            color: var(--accent-green);
            margin: 0;
            background: linear-gradient(135deg, var(--accent-green), #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            flex-shrink: 0;
        }

        .settings-card:has(.subscribe-info) {
            background: var(--card-bg);
            border: 2px solid var(--accent-green);
            position: relative;
            overflow: hidden;
        }

        .settings-card:has(.subscribe-info):hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: var(--border-color);
        }
        .settings-section {
            margin-bottom: 30px;
        }

        .settings-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px var(--shadow-light);
        }

        .settings-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-medium);
            border-color: var(--accent-green);
        }

        .settings-card.logout-card:hover {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .settings-info h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .settings-info p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .toggle-switch {
            width: 50px;
            height: 28px;
            background: var(--surface-light);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--accent-green);
        }

        .toggle-slider {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(22px);
        }

        /* Added full-screen video player overlay styles */
        .video-player-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .video-player-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .video-player-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-radius: 25px 25px 0 0;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            height: 100vh;
            overflow: hidden;
        }

        .video-player-overlay.active .video-player-container {
            transform: translateY(0);
        }

        .video-player-header {
            padding: 20px 25px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--card-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .close-video-btn {
            width: 45px;
            height: 45px;
            background: var(--surface-light);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .close-video-btn:hover {
            background: var(--accent-red);
            color: white;
            transform: scale(1.1);
        }

        .close-video-btn svg {
            width: 20px;
            height: 20px;
        }

        .video-player-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .video-iframe-container {
            padding: 0;
            height: calc(100vh - 80px);
            background: #000;
        }

        .video-iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        a{
          text-decoration:none;
          color: white;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 12px 0 8px;
            z-index: 100;
            box-shadow: 0 -4px 20px var(--shadow-light);
        }

        .nav-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }

        .nav-slider {
            position: absolute;
            top: -2px;
            left: 0;
            width: 25%;
            height: 4px;
            background: var(--accent-green);
            border-radius: 2px;
            transition: left 0.3s ease;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-muted);
            min-width: 60px;
        }

        .nav-item.active {
            color: var(--accent-green);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 12px;
            font-weight: 500;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }

        [data-theme="dark"] .loading-overlay {
            background: rgba(15, 23, 42, 0.95);
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid #000000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        [data-theme="dark"] .spinner {
            border-top-color: #ffffff;
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-align: center;
            transition: opacity 0.3s ease;
        }

        .loading-subtext {
            font-size: 14px;
            color: var(--text-secondary);
            text-align: center;
            opacity: 0.8;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        /* Animations */
        .streak-animations-active .streak-glow {
            opacity: 1;
            transform: scale(1);
        }

        .streak-animations-active .streak-fire {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        .streak-animations-active .streak-number {
            opacity: 1;
            transform: translateY(0);
        }

        .streak-animations-active .streak-text {
            opacity: 1;
            transform: translateY(0);
        }

        .streak-animations-active .streak-calendar {
            opacity: 1;
            transform: translateY(0);
        }

        .streak-animations-active .schedule-section {
            opacity: 1;
            transform: translateY(0);
        }

        /* Alert Styles */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-size: 14px;
            animation: slideDown 0.3s ease;
        }

        .alert-error {
            background-color: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .page {
                padding: 16px;
                padding-bottom: 100px;
            }
            
            .greeting h1 {
                font-size: 28px;
            }
            
            .courses-grid {
                gap: 12px;
            }
            
            .course-image-placeholder {
                height: 140px;
            }
            
            .schedule-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            /* Updated responsive styles for circular calendar days */
            .calendar-day {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">Hold on...</div>
        <div class="loading-subtext" id="loadingSubtext">Getting things ready for you</div>
    </div>

    <div class="viewport">
        <div class="main-container" id="mainContainer">
            <!-- Home Page -->
            <div class="page" id="homePage">
                <div class="header">
                    <div class="greeting">
                        <h1 id="userGreeting">Hi there</h1>
                        <p>Welcome to second semester</p>
                    </div>
                    <div class="avatar">
                        <!-- Remove hardcoded avatar URL, let JavaScript fetch and set it dynamically -->
                        <img src="/placeholder.svg" alt="Profile Avatar" id="userAvatar">
                    </div>
                </div>

                <div class="calendar-section">
                    <div class="calendar-container" id="calendarContainer">
                        <div class="calendar" id="calendar">
                            <!-- Calendar days will be generated by JavaScript -->
                        </div>
                    </div>
                    <div class="scroll-indicator">
                        <div class="scroll-indicator-thumb" id="scrollThumb"></div>
                    </div>
                </div>

                <div class="courses-section">
                    <h2 class="section-title">Your Subjects</h2>
                    <div class="courses-grid" id="coursesGrid">
                        <!-- Courses will be populated dynamically from API -->
                    </div>
                </div>
            </div>

            <!-- Videos Page -->
            <div class="page videos-page" id="videosPage">
                <div class="header">
                    <div class="greeting">
                        <h1>Videos</h1>
                        <p>Learn with video tutorials</p>
                    </div>
                </div>

                <div class="video-section">
                    <h2 class="video-section-title">Mathematics</h2>
                    <div id="grid-mathematics"></div>
                </div>

                <div class="video-section">
                    <h2 class="video-section-title">Chemistry</h2>
                    <div id="grid-chemistry"></div>
                </div>

                <div class="video-section">
                    <h2 class="video-section-title">Physics</h2>
                    <div id="grid-physics"></div>
                </div>

                <div class="video-section">
                    <h2 class="video-section-title">Engineering Drawing</h2>
                    <div id="grid-engdrawing"></div>
                </div>
            </div>

            <!-- Streaks Page -->
            <div class="page streaks-page" id="streaksPage">
                <div class="streak-container">
                    <div class="streak-glow"></div>
                    <div class="streak-fire">
                        <img src="https://rztgg9jpu58dsvst.public.blob.vercel-storage.com/IMG_7565.png" alt="Streak Fire">
                    </div>
                </div>
                
                <div class="streak-number" id="streakNumber">0</div>
                <div class="streak-text" id="streakText">Start your learning streak today! 🔥</div>
                
                <div class="streak-calendar">
                    <div class="streak-calendar-title">Streak Calendar</div>
                    <div class="calendar-month-header">
                        <div class="month-title" id="monthTitle">August 2025</div>
                    </div>
                    <div class="calendar-days-header" id="calendarDaysHeader">
                        <!-- Days header will be generated by JavaScript -->
                    </div>
                    <div class="calendar-month-grid" id="streakCalendar">
                        <!-- Calendar will be generated by JavaScript -->
                    </div>
                </div>



                <div class="schedule-section" id="scheduleSection">
                    <div id="scheduleContent">
                        <h3 class="schedule-title">Schedule your studies for the week</h3>
                        <p class="schedule-subtitle">Select the courses you want to study for the week</p>
                        
                        <div class="schedule-grid" id="scheduleGrid">
                            <!-- Schedule courses will be populated dynamically -->
                        </div>
                        
                        <button class="schedule-set-btn" id="scheduleSetBtn">Set Schedule</button>
                    </div>

                    <div id="scheduleLocked" style="display: none;">
                        <div class="schedule-locked-message">
                            <div class="schedule-locked-title">Schedule Set!</div>
                            <div class="schedule-locked-subtitle">Your study schedule is locked until Sunday</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div class="page profile-page" id="profilePage">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <!-- Remove hardcoded avatar URL, let JavaScript fetch and set it dynamically -->
                        <img src="/placeholder.svg" alt="Profile Avatar" id="profileAvatar">
                    </div>
                    <h2 class="profile-name" id="profileName">Hello</h2>
                </div>

                <div class="analytics-section">
                    <h3 class="analytics-title">Performance Analytics</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-subject">Mathematics</div>
                            <div class="analytics-score">85%</div>
                            <div class="analytics-progress">
                                <div class="analytics-progress-bar" style="width: 85%"></div>
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-subject">Chemistry</div>
                            <div class="analytics-score">78%</div>
                            <div class="analytics-progress">
                                <div class="analytics-progress-bar" style="width: 78%"></div>
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-subject">Physics</div>
                            <div class="analytics-score">92%</div>
                            <div class="analytics-progress">
                                <div class="analytics-progress-bar" style="width: 92%"></div>
                            </div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-subject">Biology</div>
                            <div class="analytics-score">88%</div>
                            <div class="analytics-progress">
                                <div class="analytics-progress-bar" style="width: 88%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-card" id="darkModeCard">
                        <div class="settings-info">
                            <h3>Dark Mode</h3>
                            <p>Switch between light and dark themes</p>
                        </div>
                        <div class="toggle-switch" id="darkModeToggle">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <a href="payment.html"><div class="subscribe-info">
                            <h4>Subscribe to get full access to complete cbt</h4>
                            <p id="currency">₦900</p>
                        </div></a>
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>

                    <div class="settings-card">
                        <div class="settings-info">
                            <h3>Join MyEasySchool Study Community</h3>
                            <p>Connect with fellow students and share knowledge</p>
                        </div>
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M9 18l6-6-6-6"/>
                        </svg>
                    </div>

                    <div class="settings-card logout-card" onclick="logout()">
                        <div class="settings-info">
                            <h3>Logout</h3>
                            <p>Sign out of your account</p>
                        </div>
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16,17 21,12 16,7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Video Player Overlay -->
        <div class="video-player-overlay" id="videoPlayerOverlay">
            <div class="video-player-container">
                <div class="video-player-header">
                    <button class="close-video-btn" onclick="closeVideoPlayer()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <h3 class="video-player-title" id="videoPlayerTitle">Video Title</h3>
                </div>
                <div class="video-iframe-container" id="videoIframeContainer">
                    <!-- YouTube iframe will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-container">
                <div class="nav-slider" id="navSlider"></div>
                <div class="nav-item active" data-page="0">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                    <span class="nav-label">Home</span>
                </div>
                
                <div class="nav-item" data-page="1">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                    </svg>
                    <span class="nav-label">Videos</span>
                </div>
                
                <div class="nav-item" data-page="2">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67z"/>
                    </svg>
                    <span class="nav-label">Streaks</span>
                </div>
                
                <div class="nav-item" data-page="3">
                    <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <span class="nav-label">Profile</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('[v0] 🚀 DASHBOARD.HTML LOADED - Console logging is working!');
        // Global variables
        let currentPage = 0;
        const totalPages = 4;
        let startX = null;
        let startY = null;
        let isDragging = false;
        let isVerticalScroll = false;
        let isHorizontalSwipe = false;
        let streakAnimationsTriggered = false;
        let courseSchedule = {};
        let nextAvailableDay = 0;
        let isScheduleLocked = false;
        let scheduledCourses = {};
        let currentStreak = 0;
        let maxStreak = 0;
        let streakData = [];
        let userId = null;
        let userToken = null;
        let userName = 'there';
        let currentUser = null;
        let userAvatar = null;

        // API Base URLs
        const API_BASE = 'https://my-easy-school-api.onrender.com/api';
const AUTH_BASE_URL = `${API_BASE}/auth`;
const STREAK_BASE_URL = `${API_BASE}/users/streak`;
const FETCH_AVATARS = `${API_BASE}/avatars`;
const AVATARS_ENDPOINT = `${API_BASE}/users/add-avatar`;

        // API Health Check and Retry Logic
        async function checkAPIHealth() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                console.log('API health check failed:', error.message);
                return false;
            }
        }
        
        // CORS Troubleshooting function
        async function diagnoseCORSIssues() {
            console.log('🔍 === CORS DIAGNOSTIC TOOL ===');
            console.log('This tool will help identify CORS-related issues');
            
            const results = {
                basicConnectivity: false,
                corsSupport: false,
                preflightSupport: false,
                authSupport: false,
                recommendations: []
            };
            
            // Test 1: Basic connectivity
            console.log('\n📡 Test 1: Basic connectivity to API server...');
            try {
                const basicResponse = await fetch(`${API_BASE.replace('/api', '')}`, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                results.basicConnectivity = true;
                console.log('✅ Basic connectivity: SUCCESS');
            } catch (error) {
                console.log('❌ Basic connectivity: FAILED -', error.message);
                results.recommendations.push('Check if the API server is running and accessible');
            }
            
            // Test 2: CORS support
            console.log('\n🌐 Test 2: CORS support...');
            try {
                const corsResponse = await fetch(`${API_BASE}/users/me`, {
                    method: 'OPTIONS',
                    mode: 'cors'
                });
                results.corsSupport = true;
                console.log('✅ CORS support: SUCCESS');
                console.log('CORS headers:', Object.fromEntries(corsResponse.headers.entries()));
            } catch (error) {
                console.log('❌ CORS support: FAILED -', error.message);
                if (error.message.includes('CORS') || error.message.includes('NotSameOrigin')) {
                    results.recommendations.push('API server needs to add CORS headers for localhost:8080');
                    results.recommendations.push('Contact API administrator to whitelist your domain');
                }
            }
            
            // Test 3: Preflight support
            console.log('\n✈️ Test 3: Preflight request support...');
            try {
                const preflightResponse = await fetch(`${API_BASE}/users/me`, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'PUT',
                        'Access-Control-Request-Headers': 'Authorization, Content-Type'
                    },
                    mode: 'cors'
                });
                results.preflightSupport = true;
                console.log('✅ Preflight support: SUCCESS');
            } catch (error) {
                console.log('❌ Preflight support: FAILED -', error.message);
                results.recommendations.push('API server needs to handle OPTIONS requests properly');
            }
            
            // Test 4: Authentication support
            console.log('\n🔐 Test 4: Authentication header support...');
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const authResponse = await fetch(`${API_BASE}/users/me`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        mode: 'cors',
                        credentials: 'omit'
                    });
                    results.authSupport = true;
                    console.log('✅ Authentication support: SUCCESS');
                } catch (error) {
                    console.log('❌ Authentication support: FAILED -', error.message);
                    results.recommendations.push('API server may not support Authorization header in CORS requests');
                }
            } else {
                console.log('⚠️ No token found - skipping auth test');
            }
            
            // Summary and recommendations
            console.log('\n📋 === DIAGNOSTIC SUMMARY ===');
            console.log('Basic Connectivity:', results.basicConnectivity ? '✅' : '❌');
            console.log('CORS Support:', results.corsSupport ? '✅' : '❌');
            console.log('Preflight Support:', results.preflightSupport ? '✅' : '❌');
            console.log('Auth Support:', results.authSupport ? '✅' : '❌');
            
            if (results.recommendations.length > 0) {
                console.log('\n💡 RECOMMENDATIONS:');
                results.recommendations.forEach((rec, index) => {
                    console.log(`${index + 1}. ${rec}`);
                });
                
                console.log('\n🛠️ POSSIBLE SOLUTIONS:');
                console.log('1. Use a CORS proxy service (temporary solution)');
                console.log('2. Deploy your app to the same domain as the API');
                console.log('3. Use a browser extension to disable CORS (development only)');
                console.log('4. Set up a local proxy server');
            }
            
            return results;
        }

        // Manual test function for PUT /users/me endpoint (can be called from browser console)
        async function testPutUsersMe() {
            console.log('[TEST] Starting manual test of PUT /users/me endpoint...');
            const token = localStorage.getItem('token');
            
            if (!token) {
                console.error('[TEST] No token found in localStorage');
                return false;
            }
            
            try {
                console.log('[TEST] Making PUT request to /users/me...');
                const response = await fetch(`${API_BASE}/users/me`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'omit' // Changed from 'include' to avoid CORS issues
                });
                
                console.log('[TEST] Response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[TEST] Response data:', data);
                    console.log('[TEST] ✅ PUT /users/me endpoint test SUCCESSFUL');
                    return true;
                } else {
                    const errorText = await response.text();
                    console.error('[TEST] ❌ PUT /users/me endpoint test FAILED:', errorText);
                    return false;
                }
            } catch (error) {
                console.error('[TEST] ❌ PUT /users/me endpoint test ERROR:', error);
                if (error.message.includes('CORS') || error.message.includes('NotSameOrigin')) {
                    console.log('[TEST] 🔍 CORS error detected! Run diagnoseCORSIssues() for detailed analysis');
                }
                return false;
            }
        }

        // Test API endpoint accessibility
        async function testAPIEndpoint() {
            console.log('[DEBUG] Testing API endpoint accessibility...');
            try {
                // Try a simple OPTIONS request first to check CORS
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('[DEBUG] API test timeout, aborting...');
                    controller.abort();
                }, 5000); // 5 second timeout
                
                // Test with OPTIONS to check if the endpoint accepts requests
                const response = await fetch(`${API_BASE}/users/me`, {
                    method: 'OPTIONS',
                    signal: controller.signal,
                    mode: 'cors'
                });
                
                clearTimeout(timeoutId);
                console.log('[DEBUG] API OPTIONS test response:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                // Check if PUT method is allowed
                const allowedMethods = response.headers.get('Allow') || response.headers.get('Access-Control-Allow-Methods') || '';
                console.log('[DEBUG] Allowed methods:', allowedMethods);
                
                if (allowedMethods.includes('PUT')) {
                    console.log('[DEBUG] PUT method is allowed');
                    return true;
                } else {
                    console.log('[DEBUG] PUT method may not be explicitly allowed, but proceeding with test');
                    return true; // Still proceed as some servers don't list all methods
                }
            } catch (error) {
                console.error('[DEBUG] API endpoint test failed:', error);
                console.error('[DEBUG] Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                // If OPTIONS fails, try a simple GET without auth to see if server is reachable
                try {
                    console.log('[DEBUG] Trying basic connectivity test...');
                    const basicResponse = await fetch(`${API_BASE.replace('/api', '')}`, {
                        method: 'GET',
                        mode: 'no-cors'
                    });
                    console.log('[DEBUG] Basic connectivity test completed');
                    return true;
                } catch (basicError) {
                    console.error('[DEBUG] Basic connectivity test also failed:', basicError);
                    return false;
                }
            }
        }
        
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                let controller;
                let timeoutId;
                try {
                    console.log(`[DEBUG] API request attempt ${attempt}/${maxRetries} to ${url}`);
                    console.log(`[DEBUG] Request options:`, {
                        method: options.method,
                        headers: options.headers ? Object.keys(options.headers) : 'none',
                        hasAuth: options.headers?.Authorization ? 'yes' : 'no'
                    });
                    
                    controller = new AbortController();
                    timeoutId = setTimeout(() => {
                        console.log(`[DEBUG] Request timeout after 12s, aborting...`);
                        controller.abort();
                    }, 12000); // 12 second timeout
                    
                    // Enhanced CORS configuration
                    const isGet = (options.method || 'GET').toUpperCase() === 'GET';
                    const headerBase = { ...(options.headers || {}), 'Accept': 'application/json' };
                    if (isGet) {
                        delete headerBase['Content-Type'];
                        delete headerBase['content-type'];
                    } else {
                        headerBase['Content-Type'] = 'application/json';
                    }
                    const corsOptions = {
                        ...options,
                        mode: 'cors',
                        credentials: 'omit', // Don't send cookies to avoid CORS issues
                        headers: headerBase,
                        signal: controller.signal
                    };
                    
                    console.log(`[DEBUG] Making fetch request with CORS config...`);
                    const response = await fetch(url, corsOptions);
                    
                    console.log(`[DEBUG] Response received:`, {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok,
                        headers: response.headers ? 'present' : 'missing'
                    });
                    
                    clearTimeout(timeoutId);
                    return response;
                } catch (error) {
                    console.log(`[DEBUG] Attempt ${attempt} failed:`, error.message);
                    if (timeoutId) clearTimeout(timeoutId);
                    
                    // Check for CORS-specific errors
                    if (error.message.includes('CORS') || error.message.includes('NotSameOrigin')) {
                        console.log(`[DEBUG] CORS error detected, trying alternative approach...`);
                        
                        // Try with no-cors mode as fallback (limited functionality but may work)
                        if (attempt === maxRetries) {
                            try {
                                console.log(`[DEBUG] Attempting no-cors fallback...`);
                                const fallbackResponse = await fetch(url, {
                                    ...options,
                                    mode: 'no-cors',
                                    credentials: 'omit'
                                });
                                console.log(`[DEBUG] No-cors fallback response:`, fallbackResponse);
                                return fallbackResponse;
                            } catch (fallbackError) {
                                console.log(`[DEBUG] No-cors fallback also failed:`, fallbackError.message);
                                throw error; // Throw original error
                            }
                        }
                    }
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // Exponential backoff: wait 2^attempt seconds
                    const waitTime = Math.pow(2, attempt) * 1000;
                    console.log(`Waiting ${waitTime}ms before retry...`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
        }

        // Days of the week
        const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const dayAbbreviations = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

        // Video data
        const sections = {
            mathematics: [
                { videoId: "fLMN0wtiz-4", title: "Introduction to Set theory" },
                { videoId: "fnhFneOz6n8", title: "Logarithm" },
                { videoId: "ZFPkQkURSxk", title: "Explanation of Functions" },
                { videoId: "F-aqjOfs_Cw", title: "Algebra" }
            ],
            chemistry: [
                { videoId: "oW7USk5x4do", title: "Introduction to Atom's" },
                { videoId: "hePb00CqvP0", title: "Periodic table: Ionization, Atomic radius and Electronic negativity" },
                { videoId: "5gEWOh630b8", title: "Chemical Bonding" },
                { videoId: "B1bWIrOe0SE", title: "Thermodynamics" }
            ],
            physics: [
                { videoId: "-Py2zI29THg", title: "Vectors and acceleration" },
                { videoId: "ptwmRcmFm9k", title: "A bullet of mass 10g strikes a ballistic pendulum" },
                { videoId: "6qQDUemzBs4", title: "Elastic Collision between two bodies" },
                { videoId: "bh39g-VLZ0Q", title: "How to calculate projectile motion" }
            ],
            engdrawing: [
                { videoId: "LjibpLFSJzA", title: "How to circumscribe a circle" },
                { videoId: "F7a60WnQn4c", title: "How to inscribe a circle" },
                { videoId: "O5iwW1NDbEg", title: "How to draw 4 circles that touch both sides of a square" },
                { videoId: "_AXpLf1qxrA", title: "How to construct 45° angle" }
            ]
        };

        // Course image mapping for different subjects
        const courseImageMap = {
            'mathematics': 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/images%20-%202025-07-30T111520.542-63xeOS7TT5Hq7W6ZLW9WrbbtbD5cin.jpeg',
            'math': 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/images%20-%202025-07-30T111520.542-63xeOS7TT5Hq7W6ZLW9WrbbtbD5cin.jpeg',
            'chemistry': 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/images%20-%202025-07-30T111856.899-5PAZFm2q7bDYEC66oUqk4tHOEG12Ew.jpeg',
            'physics': 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/images%20-%202025-07-30T112139.548-W0gvpmrDKeKD2EW4oLthxMahJmVcbL.jpeg',
            'biology': 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/images%20-%202025-08-05T002730.635-3x7V53qZp3zwyodV4NuHKCur0tp1E3.jpeg',
            'computer': 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/images%20-%202025-08-05T002854.457-GSQvL38ybLGSF7ZTxbpGIiYMPDhUIo.jpeg',
            'npc': 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/images%20-%202025-07-30T111321.684-z1SqOh7mSDuP1vXmmVl8hNp0UdxWbj.jpeg',
            'nigeria': 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/images%20-%202025-07-30T111321.684-z1SqOh7mSDuP1vXmmVl8hNp0UdxWbj.jpeg',
            'default': 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/images%20-%202025-07-30T111520.542-63xeOS7TT5Hq7W6ZLW9WrbbtbD5cin.jpeg'
        };

        // Utility functions
        function showAlert(message, type = 'error') {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) existingAlert.remove();
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            const container = document.querySelector('.page') || document.body;
            container.insertBefore(alert, container.firstChild);
            
            setTimeout(() => {
                if (alert.parentNode) alert.remove();
            }, 5000);
        }

        // Get appropriate image for course
        function getCourseImage(courseName, courseCode) {
            const name = courseName.toLowerCase();
            const code = courseCode.toLowerCase();
            
            // Check for specific subject keywords
            for (const [key, image] of Object.entries(courseImageMap)) {
                if (name.includes(key) || code.includes(key)) {
                    return image;
                }
            }
            
            return courseImageMap.default;
        }

        async function fetchCourses() {
            try {
                let semesterToUse = getCurrentSemester();
                if (!semesterToUse || !semesterToUse._id) {
                    console.warn('[v0] No current semester found, attempting to resolve from university...');
                    const storedUserData = JSON.parse(localStorage.getItem('currentUserData') || '{}');
                    let uniRef = storedUserData?.user?.university || currentUser?.university || currentUser?.customUniversity;
                    let uniId = uniRef?._id || uniRef?.id || (typeof uniRef === 'string' ? uniRef : null);

                    // If we have a university reference but no id, try to resolve by name
                    if (!uniId && uniRef) {
                        try {
                            const universities = await fetchAllUniversities();
                            const refName = (uniRef?.name || (typeof uniRef === 'string' ? uniRef : '')).toLowerCase().trim();
                            const matchedUni = Array.isArray(universities) ? universities.find(u => {
                                const candidateName = (u.name || u.universityName || u.title || '').toLowerCase().trim();
                                return candidateName && candidateName === refName;
                            }) : null;
                            if (matchedUni) {
                                uniId = matchedUni._id || matchedUni.id;
                                console.log('[v0] Resolved university by name:', matchedUni);
                                // Persist resolved university object
                                const updatedUserDataPersist = {
                                    ...storedUserData,
                                    user: {
                                        ...(storedUserData.user || currentUser || {}),
                                        university: matchedUni
                                    }
                                };
                                localStorage.setItem('currentUserData', JSON.stringify(updatedUserDataPersist));
                            } else {
                                console.warn('[v0] Could not resolve university by name:', refName);
                            }
                        } catch (e) {
                            console.error('[v0] Error resolving university by name:', e);
                        }
                    }

                    if (uniId) {
                        const semesters = await fetchSemestersByUniversity(uniId);
                        if (Array.isArray(semesters) && semesters.length > 0) {
                            // Pick most recent by startDate if available
                            semesters.sort((a, b) => new Date(b.startDate || 0) - new Date(a.startDate || 0));
                            semesterToUse = semesters[0];
                            const updatedUserData = {
                                ...storedUserData,
                                currentSemester: semesterToUse
                            };
                            localStorage.setItem('currentUserData', JSON.stringify(updatedUserData));
                            console.log('[v0] Resolved semester from university:', semesterToUse?._id);
                        } else {
                            console.error('[v0] No semesters available for university:', uniId);
                            showAlert('No semester available for your university', 'warning');
                        }
                    } else {
                        console.error('[v0] University ID missing; cannot resolve semester');
                        showAlert('University information missing', 'warning');
                    }
                }

                if (!semesterToUse || !semesterToUse._id) {
                    console.warn('[v0] Using default courses fallback due to missing semester');
                    loadDefaultCourses();
                    return;
                }

                const response = await fetchWithRetry(`${API_BASE}/courses/semester/${semesterToUse._id}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });

                if (response.ok) {
                    const apiResponse = await response.json();
                    console.log('[v0] Full API response:', apiResponse);
                    
                    // Handle different possible response structures
                    let courses;
                    if (Array.isArray(apiResponse)) {
                        courses = apiResponse;
                    } else if (apiResponse.data && Array.isArray(apiResponse.data)) {
                        courses = apiResponse.data;
                    } else if (apiResponse.courses && Array.isArray(apiResponse.courses)) {
                        courses = apiResponse.courses;
                    } else if (apiResponse.result && Array.isArray(apiResponse.result)) {
                        courses = apiResponse.result;
                    } else {
                        console.error('[v0] Unexpected API response structure:', apiResponse);
                        throw new Error('Invalid API response structure');
                    }
                    
                    console.log('[v0] Extracted courses array:', courses);
                    
                    if (!Array.isArray(courses) || courses.length === 0) {
                        console.warn('[v0] No courses found in response');
                        showAlert('No courses found for this semester', 'warning');
                        loadDefaultCourses();
                        return;
                    }
                    
                    populateCoursesGrid(courses);
                    populateScheduleGrid(courses);
                } else {
                    console.error('Failed to fetch courses:', response.status);
                    showAlert('Failed to load courses', 'error');
                    // Fallback to default courses if API fails
                    loadDefaultCourses();
                }
            } catch (error) {
                console.error('Error fetching courses:', error);
                
                // Provide specific error messages based on error type
                if (error.name === 'AbortError') {
                    console.warn('Courses request timed out. The server may be starting up (common with free hosting).');
                    showAlert('Request timed out. Server may be starting up...', 'warning');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    console.warn('Unable to connect to the server. Please check your internet connection.');
                    showAlert('Unable to connect to server. Check your connection.', 'error');
                } else if (error.message.includes('ERR_TIMED_OUT')) {
                    console.warn('Connection timed out. The server may be sleeping (free hosting limitation).');
                    showAlert('Connection timed out. Server may be sleeping...', 'warning');
                } else {
                    showAlert('Error loading courses', 'error');
                }
                
                // Fallback to default courses if API fails
                loadDefaultCourses();
            }
        }

        // Load default courses as fallback
        function loadDefaultCourses() {
            const defaultCourses = [
                { _id: '1', courseCode: 'NPC 121', courseName: 'Nigeria People and Culture' },
                { _id: '2', courseCode: 'MTH 112', courseName: 'Mathematics' },
                { _id: '3', courseCode: 'CHM 102', courseName: 'Chemistry' },
                { _id: '4', courseCode: 'PHY 102', courseName: 'Physics' },
                { _id: '5', courseCode: 'BIO 102', courseName: 'Biology' },
                { _id: '6', courseCode: 'CSC 102', courseName: 'Computer' },
                { _id: '7', courseCode: 'PHY 104', courseName: 'Physics Lab' },
                { _id: '8', courseCode: 'CHM 104', courseName: 'Chemistry Lab' }
            ];
            
            populateCoursesGrid(defaultCourses);
            populateScheduleGrid(defaultCourses);
        }

        // Populate courses grid dynamically
        function populateCoursesGrid(courses) {
            const coursesGrid = document.getElementById('coursesGrid');
            coursesGrid.innerHTML = '';

            courses.forEach(course => {
                const courseCard = document.createElement('div');
                courseCard.className = 'course-card';
                courseCard.setAttribute('data-course', course.courseCode);
                courseCard.onclick = () => handleCourseClick(course._id, course.courseCode);

                const courseImage = getCourseImage(course.courseName, course.courseCode);

                courseCard.innerHTML = `
                    <div class="course-image-placeholder">
                        <img src="${courseImage}" alt="${course.courseName}">
                    </div>
                    <div class="course-content">
                        <div class="course-title">${course.courseName}</div>
                        <div class="course-code">${course.courseCode}</div>
                        <div class="course-schedule-indicator"></div>
                    </div>
                `;

                coursesGrid.appendChild(courseCard);
            });
        }

        // Populate schedule grid dynamically
        function populateScheduleGrid(courses) {
            const scheduleGrid = document.getElementById('scheduleGrid');
            scheduleGrid.innerHTML = '';

            courses.forEach(course => {
                const scheduleCard = document.createElement('div');
                scheduleCard.className = 'schedule-course';
                scheduleCard.setAttribute('data-course', course.courseCode);

                scheduleCard.innerHTML = `
                    <div class="schedule-course-controls">
                        <button class="schedule-control-btn schedule-minus-btn">−</button>
                        <button class="schedule-control-btn schedule-plus-btn">+</button>
                    </div>
                    <div class="schedule-course-title">${course.courseCode}</div>
                    <div class="schedule-course-day"></div>
                `;

                scheduleGrid.appendChild(scheduleCard);
            });

            // Re-setup course scheduling after populating
            setupCourseScheduling();
        }

        async function fetchCurrentUserData(token) {
            try {
                console.log('[DEBUG] Starting fetchCurrentUserData...');
                console.log('[DEBUG] Token exists:', !!token);
                console.log('[DEBUG] Token length:', token ? token.length : 0);
                console.log('[DEBUG] API endpoint:', `${API_BASE}/users/me`);
                
                // Check if token is valid format
                if (!token || token.length < 10) {
                    console.error('[DEBUG] Invalid token format');
                    return null;
                }
                
                const res = await fetchWithRetry(`${API_BASE}/users/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (res.ok) {
                    const raw = await res.json();
                    // Support various API response wrappers: { result: {...} }, { data: {...} }, or plain object
                    const effective = (raw && (raw.result || raw.data)) ? (raw.result || raw.data) : raw;
                    
                    let currentSemester = null;
                    if (effective.currentSemester && typeof effective.currentSemester === 'object') {
                        currentSemester = effective.currentSemester;
                    } else if (effective.semester && typeof effective.semester === 'object') {
                        currentSemester = effective.semester;
                    } else if (effective.semesterName || effective.academicYear) {
                        currentSemester = {
                            _id: effective.currentSemester?._id || effective._id,
                            semesterName: effective.semesterName,
                            academicYear: effective.academicYear,
                            startDate: effective.startDate,
                            endDate: effective.endDate,
                            university: effective.university,
                            createdAt: effective.createdAt,
                            updatedAt: effective.updatedAt
                        };
                    }
                    
                    let user = null;
                    if (effective.user && typeof effective.user === 'object') {
                        user = effective.user;
                    } else if (effective.currentUser && typeof effective.currentUser === 'object') {
                        user = effective.currentUser;
                    } else if (effective.profile && typeof effective.profile === 'object') {
                        user = effective.profile;
                    } else {
                        user = {
                            _id: effective.user?._id || effective._id,
                            email: effective.user?.email || effective.email,
                            avatar: effective.user?.avatar || effective.avatar,
                            isActive: effective.user?.isActive ?? effective.isActive,
                            lastLoginAt: effective.user?.lastLoginAt || effective.lastLoginAt,
                            role: effective.user?.role || effective.role,
                            university: effective.user?.university || effective.university,
                            courses: effective.user?.courses || effective.courses || [],
                            totalXP: effective.user?.totalXP ?? effective.totalXP ?? 0,
                            weeklyXP: effective.user?.weeklyXP ?? effective.weeklyXP ?? 0,
                            streakCount: effective.user?.streakCount ?? effective.streakCount ?? 0,
                            maxStreak: effective.user?.maxStreak ?? effective.maxStreak ?? 0,
                            lastQuizStartDate: effective.user?.lastQuizStartDate || effective.lastLoginAt || effective.lastQuizStartDate,
                            currentToken: effective.user?.currentToken || effective.currentToken,
                            subscribed: effective.user?.subscribed ?? effective.subscribed ?? false,
                            subscribedSemester: effective.user?.subscribedSemester || effective.subscribedSemester,
                            subscriptionStartDate: effective.user?.subscriptionStartDate || effective.subscriptionStartDate,
                            subscriptionEndDate: effective.user?.subscriptionEndDate || effective.subscriptionEndDate
                        };
                    }
                    
                    // If semester is not an object but we have an ID somewhere, fetch it
                    if (!currentSemester) {
                        const semesterIdCandidate = effective.currentSemesterId 
                            || (typeof effective.currentSemester === 'string' ? effective.currentSemester : null)
                            || (typeof user?.subscribedSemester === 'string' ? user.subscribedSemester : (user?.subscribedSemester?._id))
                            || localStorage.getItem('selectedSemesterId')
                            || localStorage.getItem('currentSemesterId');
                        
                        if (semesterIdCandidate) {
                            try {
                                const fetchedSemester = await fetchSemesterById(semesterIdCandidate);
                                if (fetchedSemester) {
                                    currentSemester = fetchedSemester;
                                }
                            } catch (semErr) {
                                console.warn('[v0] Failed to fetch semester by ID, proceeding without:', semesterIdCandidate, semErr);
                            }
                        }
                    }
                    
                    const userData = {
                        user: user,
                        currentSemester: currentSemester
                    };
                    
                    localStorage.setItem('currentUserData', JSON.stringify(userData));
                    localStorage.setItem('user', JSON.stringify(userData.user));
                    localStorage.setItem('userId', userData.user._id || userData.user.id || 'user123');
                    if (userData.currentSemester?._id) {
                        localStorage.setItem('currentSemesterId', userData.currentSemester._id);
                    }
                    
                    return userData;
                } else {
                    const errorText = await res.text().catch(() => '');
                    console.error('Failed to fetch current user data', { status: res.status, statusText: res.statusText, body: errorText });
                    return null;
                }
            } catch (error) {
                console.error('Error fetching current user data:', error);
                
                // Provide specific error messages based on error type
                if (error.name === 'AbortError') {
                    console.warn('User data request timed out. The server may be starting up (common with free hosting).');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    console.warn('Unable to connect to the server. Please check your internet connection.');
                } else if (error.message.includes('ERR_TIMED_OUT')) {
                    console.warn('Connection timed out. The server may be sleeping (free hosting limitation).');
                } else if (error.message.includes('ERR_ABORTED')) {
                    console.error('[DEBUG] Request was aborted - trying fallback approach');
                    
                    // Try a simpler request without retry mechanism
                    try {
                        console.log('[DEBUG] Attempting direct fetch without retry...');
                        const directResponse = await fetch(`${API_BASE}/users/me`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            mode: 'cors',
                            credentials: 'omit' // Changed from 'include' to avoid CORS issues
                        });
                        
                        if (directResponse.ok) {
                            const responseData = await directResponse.json();
                            console.log('[DEBUG] Direct fetch succeeded:', responseData);
                            
                            // Process the response data the same way as above
                            let currentSemester = null;
                            if (responseData.currentSemester && typeof responseData.currentSemester === 'object') {
                                currentSemester = responseData.currentSemester;
                            } else if (responseData.semesterName || responseData.academicYear) {
                                currentSemester = {
                                    _id: responseData.currentSemester?._id || responseData._id,
                                    semesterName: responseData.semesterName,
                                    academicYear: responseData.academicYear,
                                    startDate: responseData.startDate,
                                    endDate: responseData.endDate,
                                    university: responseData.university,
                                    createdAt: responseData.createdAt,
                                    updatedAt: responseData.updatedAt
                                };
                            }
                            
                            let user = null;
                            if (responseData.user && typeof responseData.user === 'object') {
                                user = responseData.user;
                            } else {
                                user = {
                                    _id: responseData.user?._id || responseData._id,
                                    email: responseData.user?.email || responseData.email,
                                    avatar: responseData.user?.avatar || responseData.avatar,
                                    isActive: responseData.user?.isActive ?? responseData.isActive,
                                    lastLoginAt: responseData.user?.lastLoginAt || responseData.lastLoginAt,
                                    role: responseData.user?.role || responseData.role,
                                    university: responseData.user?.university || responseData.university,
                                    courses: responseData.user?.courses || responseData.courses || [],
                                    totalXP: responseData.user?.totalXP ?? responseData.totalXP ?? 0,
                                    weeklyXP: responseData.user?.weeklyXP ?? responseData.weeklyXP ?? 0,
                                    streakCount: responseData.user?.streakCount ?? responseData.streakCount ?? 0,
                                    maxStreak: responseData.user?.maxStreak ?? responseData.maxStreak ?? 0,
                                    lastQuizStartDate: responseData.user?.lastQuizStartDate || responseData.lastQuizStartDate,
                                    currentToken: responseData.user?.currentToken || responseData.currentToken,
                                    subscribed: responseData.user?.subscribed ?? responseData.subscribed ?? false,
                                    subscribedSemester: responseData.user?.subscribedSemester || responseData.subscribedSemester,
                                    subscriptionStartDate: responseData.user?.subscriptionStartDate || responseData.subscriptionStartDate,
                                    subscriptionEndDate: responseData.user?.subscriptionEndDate || responseData.subscriptionEndDate
                                };
                            }
                            
                            const userData = {
                                user: user,
                                currentSemester: currentSemester
                            };
                            
                            localStorage.setItem('currentUserData', JSON.stringify(userData));
                            localStorage.setItem('user', JSON.stringify(userData.user));
                            localStorage.setItem('userId', userData.user._id || userData.user.id || 'user123');
                            
                            return userData;
                        } else {
                            throw new Error(`Direct fetch failed with status: ${directResponse.status}`);
                        }
                    } catch (fallbackError) {
                        console.error('[DEBUG] Fallback approach also failed:', fallbackError);
                        console.warn('Unable to connect to the server. Please try refreshing the page or contact support.');
                    }
                } else if (error.message.includes('CORS') || error.message.includes('NotSameOrigin')) {
                    console.error('[DEBUG] CORS error detected in fetchCurrentUserData');
                    console.error('[DEBUG] This is likely due to the API server not allowing requests from localhost:8080');
                    console.error('[DEBUG] Possible solutions:');
                    console.error('[DEBUG] 1. API server needs to add CORS headers');
                    console.error('[DEBUG] 2. Use a proxy server');
                    console.error('[DEBUG] 3. Deploy to the same domain as the API');
                    
                    // Try a no-cors fallback (limited functionality)
                    try {
                        console.log('[DEBUG] Attempting no-cors fallback for user data...');
                        const noCorsResponse = await fetch(`${API_BASE}/users/me`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            mode: 'no-cors',
                            credentials: 'omit'
                        });
                        
                        console.log('[DEBUG] No-cors response received (opaque):', noCorsResponse);
                        // Note: no-cors responses are opaque, so we can't read the data
                        // This is just to test if the request goes through
                        
                    } catch (noCorsError) {
                        console.error('[DEBUG] No-cors fallback also failed:', noCorsError.message);
                    }
                    
                    return null;
                }
                
                return null;
            }
        }

        // Get current semester from stored user data
        function getCurrentSemester() {
            const userData = JSON.parse(localStorage.getItem('currentUserData') || '{}');
            return userData.currentSemester || null;
        }

        // Resolve current semester using stored object, ID, or university fallback
        async function resolveCurrentSemester() {
            try {
                const storedUserData = JSON.parse(localStorage.getItem('currentUserData') || '{}');
                let semester = storedUserData?.currentSemester;
                if (semester && semester._id) return semester;

                let semId = localStorage.getItem('currentSemesterId')
                    || (typeof storedUserData?.currentSemester === 'string' ? storedUserData.currentSemester : null)
                    || (typeof currentUser?.subscribedSemester === 'string' ? currentUser.subscribedSemester : (currentUser?.subscribedSemester?._id));

                if (semId) {
                    try {
                        const fetched = await fetchSemesterById(semId);
                        if (fetched && fetched._id) {
                            const updated = { ...storedUserData, currentSemester: fetched };
                            localStorage.setItem('currentUserData', JSON.stringify(updated));
                            localStorage.setItem('currentSemesterId', fetched._id);
                            console.log('[v0] Resolved semester by ID:', fetched._id);
                            return fetched;
                        }
                    } catch (e) {
                        console.warn('[v0] Failed to resolve semester by ID:', semId, e);
                    }
                }

                let uniRef = storedUserData?.user?.university || currentUser?.university || currentUser?.customUniversity;
                let uniId = uniRef?._id || uniRef?.id || (typeof uniRef === 'string' ? uniRef : null);

                if (!uniId && uniRef) {
                    try {
                        const universities = await fetchAllUniversities();
                        const refName = (uniRef?.name || (typeof uniRef === 'string' ? uniRef : '')).toLowerCase().trim();
                        const matchedUni = Array.isArray(universities) ? universities.find(u => {
                            const candidateName = (u.name || u.universityName || u.title || '').toLowerCase().trim();
                            return candidateName && candidateName === refName;
                        }) : null;
                        if (matchedUni) {
                            uniId = matchedUni._id || matchedUni.id;
                            const updatedPersist = {
                                ...storedUserData,
                                user: {
                                    ...(storedUserData.user || currentUser || {}),
                                    university: matchedUni
                                }
                            };
                            localStorage.setItem('currentUserData', JSON.stringify(updatedPersist));
                            console.log('[v0] Resolved university by name for semester resolution:', matchedUni);
                        }
                    } catch (e) {
                        console.error('[v0] Error resolving university for semester:', e);
                    }
                }

                if (uniId) {
                    try {
                        const semesters = await fetchSemestersByUniversity(uniId);
                        if (Array.isArray(semesters) && semesters.length > 0) {
                            semesters.sort((a, b) => new Date(b.startDate || 0) - new Date(a.startDate || 0));
                            const picked = semesters[0];
                            const updated = { ...storedUserData, currentSemester: picked };
                            localStorage.setItem('currentUserData', JSON.stringify(updated));
                            if (picked?._id) localStorage.setItem('currentSemesterId', picked._id);
                            console.log('[v0] Resolved semester from university:', picked?._id);
                            return picked;
                        } else {
                            console.warn('[v0] No semesters available for university:', uniId);
                        }
                    } catch (e) {
                        console.error('[v0] Error fetching semesters for university:', e);
                    }
                }

                return null;
            } catch (e) {
                console.error('[v0] Unexpected error resolving current semester:', e);
                return null;
            }
        }

        // Fetch all universities using the /universities/all endpoint
        async function fetchAllUniversities() {
            try {
                const response = await fetchWithRetry(`${API_BASE}/universities/all`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });

                if (response.ok) {
                    const raw = await response.json();
                    const universities = Array.isArray(raw) ? raw
                        : (Array.isArray(raw.universities) ? raw.universities
                        : (Array.isArray(raw.data) ? raw.data
                        : (Array.isArray(raw.result) ? raw.result : [])));
                    console.log('[v0] Universities fetched successfully:', universities);
                    return universities;
                } else {
                    console.warn('Failed to fetch universities with auth:', response.status, '— retrying without Authorization');
                    const response2 = await fetchWithRetry(`${API_BASE}/universities/all`, {
                        method: 'GET'
                    });
                    if (response2.ok) {
                        const raw2 = await response2.json();
                        const universities2 = Array.isArray(raw2) ? raw2
                            : (Array.isArray(raw2.universities) ? raw2.universities
                            : (Array.isArray(raw2.data) ? raw2.data
                            : (Array.isArray(raw2.result) ? raw2.result : [])));
                        console.log('[v0] Universities fetched successfully (no auth):', universities2);
                        return universities2;
                    }
                    console.error('Failed to fetch universities (no auth):', response2.status);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching universities:', error);
                
                // Provide specific error messages based on error type
                if (error.name === 'AbortError') {
                    console.warn('Universities request timed out. The server may be starting up (common with free hosting).');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    console.warn('Unable to connect to the server. Please check your internet connection.');
                } else if (error.message.includes('ERR_TIMED_OUT')) {
                    console.warn('Connection timed out. The server may be sleeping (free hosting limitation).');
                }
                
                return null;
            }
        }

        // Fetch semester data for a specific university using /semesters/university/{universityId}
        async function fetchSemestersByUniversity(universityId) {
            try {
                const response = await fetchWithRetry(`${API_BASE}/semesters/university/${universityId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });

                if (response.ok) {
                    const raw = await response.json();
                    const semesters = Array.isArray(raw) ? raw
                        : (Array.isArray(raw.semesters) ? raw.semesters
                        : (Array.isArray(raw.data) ? raw.data
                        : (Array.isArray(raw.result) ? raw.result : [])));
                    console.log('[v0] Semesters fetched successfully for university:', universityId, semesters);
                    return semesters;
                } else {
                    console.warn('Failed to fetch semesters with auth:', universityId, response.status, '— retrying without Authorization');
                    const response2 = await fetchWithRetry(`${API_BASE}/semesters/university/${universityId}`, {
                        method: 'GET'
                    });
                    if (response2.ok) {
                        const raw2 = await response2.json();
                        const semesters2 = Array.isArray(raw2) ? raw2
                            : (Array.isArray(raw2.semesters) ? raw2.semesters
                            : (Array.isArray(raw2.data) ? raw2.data
                            : (Array.isArray(raw2.result) ? raw2.result : [])));
                        console.log('[v0] Semesters fetched successfully for university (no auth):', universityId, semesters2);
                        return semesters2;
                    }
                    console.error('Failed to fetch semesters for university (no auth):', universityId, response2.status);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching semesters for university:', universityId, error);
                
                // Provide specific error messages based on error type
                if (error.name === 'AbortError') {
                    console.warn('Semesters request timed out. The server may be starting up (common with free hosting).');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    console.warn('Unable to connect to the server. Please check your internet connection.');
                } else if (error.message.includes('ERR_TIMED_OUT')) {
                    console.warn('Connection timed out. The server may be sleeping (free hosting limitation).');
                }
                
                return null;
            }
        }

        // Fetch specific semester data using /semesters/{id}
        async function fetchSemesterById(semesterId) {
            try {
                const response = await fetchWithRetry(`${API_BASE}/semesters/${semesterId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });

                if (response.ok) {
                    const semester = await response.json();
                    console.log('[v0] Semester fetched successfully:', semesterId, semester);
                    return semester;
                } else {
                    console.error('Failed to fetch semester:', semesterId, response.status);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching semester:', semesterId, error);
                
                // Provide specific error messages based on error type
                if (error.name === 'AbortError') {
                    console.warn('Semester request timed out. The server may be starting up (common with free hosting).');
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    console.warn('Unable to connect to the server. Please check your internet connection.');
                } else if (error.message.includes('ERR_TIMED_OUT')) {
                    console.warn('Connection timed out. The server may be sleeping (free hosting limitation).');
                }
                
                return null;
            }
        }

        async function checkAuthStatus() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            console.log('[v0] Dashboard page loaded, checking authentication');
            console.log('[v0] Token exists:', !!token, 'User email:', user.email);
            
            // Update loading text for authentication check
            updateLoadingText('Verifying your session...', 'Checking authentication status');
            
            if (!token || !user.email) {
                console.log('[v0] Authentication failed, redirecting to login');
                updateLoadingText('Authentication required', 'Redirecting to sign in...');
                setTimeout(() => {
                    window.location.href = 'sign-in.html';
                }, 1500);
                return false;
            } else {
                console.log('[v0] User authenticated, testing API and fetching current user data');
                updateLoadingText('Loading your profile...', 'Testing server connection');
                
                try {
                    // Test API endpoint first
                    const apiAccessible = await testAPIEndpoint();
                    if (!apiAccessible) {
                        console.warn('[DEBUG] API endpoint not accessible, switching to offline mode');
                        updateLoadingText('Working offline', 'Using saved profile');

                        // Use stored user data for offline mode
                        userId = user._id || user.id || 'user123';
                        userName = user.fullName || user.name || 'Student';
                        userAvatar = user.avatar;
                        userToken = token;
                        currentUser = user;

                        updateUserInfo();
                        return true; // Proceed with offline data
                    }
                    
                    updateLoadingText('Loading your profile...', 'Getting user information');
                    
                    // Fetch current user data when dashboard loads
                    const userData = await fetchCurrentUserData(token);
                    
                    if (userData && userData.user) {
                        console.log('[v0] User data fetched successfully');
                        // Token is valid, update user info
                        userId = userData.user._id || userData.user.id || 'user123';
                        userName = userData.user.fullName || userData.user.name || 'Student';
                        userAvatar = userData.user.avatar;
                        userToken = token;
                        currentUser = userData.user;
                        
                        updateLoadingText('Checking university selection...', 'Validating profile information');
                        
                        const selectedUniversity = userData.user?.university;
                        if (!selectedUniversity || !selectedUniversity._id) {
                            console.log('[v0] No university selected, redirecting to university selection');
                            updateLoadingText('University selection required', 'Redirecting to university selection...');
                            setTimeout(() => {
                                window.location.href = 'university-selection.html';
                            }, 1500);
                            return false;
                        }
                        
                        if (!userData.currentSemester || !userData.currentSemester._id) {
                            console.log('[v0] No current semester found — proceeding with dashboard; user can select semester later.');
                        }
                        
                        console.log('[v0] University validated, initializing dashboard');
                        updateLoadingText('Preparing your dashboard...', 'Loading courses and content');
                        updateUserInfo();
                        
                        return true;
                    } else {
                        console.log('[v0] Token verification failed, redirecting to login');
                        // Token verification failed
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        localStorage.removeItem('currentUserData');
                        updateLoadingText('Session expired', 'Redirecting to sign in...');
                        setTimeout(() => {
                            window.location.href = 'sign-in.html';
                        }, 1500);
                        return false;
                    }
                } catch (error) {
                    console.error('[v0] Auth check failed:', error);
                    console.error('Error fetching user data:', error);
                    // On network error, use stored data if available
                    if (user.email) {
                        userId = user._id || user.id || 'user123';
                        userName = user.fullName || user.name || 'Student';
                        userAvatar = user.avatar;
                        userToken = token;
                        updateUserInfo();
                        return true;
                    } else {
                        updateLoadingText('Connection error', 'Please check your internet connection');
                        setTimeout(() => {
                            window.location.href = 'sign-in.html';
                        }, 2000);
                        return false;
                    }
                }
            }
        }

        function updateUserInfo() {
            const firstName = userName.split(' ')[0];
            const userGreetingElement = document.getElementById('userGreeting');
            const profileNameElement = document.getElementById('profileName');
            
            if (userGreetingElement) {
                userGreetingElement.textContent = `Hi ${firstName}`;
            }
            if (profileNameElement) {
                profileNameElement.textContent = userName;
            }
            
            updateAvatarDisplay();
        }

        async function fetchAvatars() {
            try {
                console.log('[v0] Fetching avatars from API...');
                
                const resp = await fetch(FETCH_AVATARS, {
                    method: 'GET'
                });

                if (!resp.ok) {
                    throw new Error(`HTTP error! status: ${resp.status}`);
                }

                const data = await resp.json();
                console.log('[v0] Avatars fetched successfully:', data);
                
                if (data.avatars && data.avatars.length > 0 && currentUser?.avatar) {
                    console.log('[v0] Looking for user avatar:', currentUser.avatar);
                    console.log('[v0] Available avatar names:', data.avatars.map(a => a.name));
                    
                    // Handle both full path and filename formats for avatar matching
                    let userCurrentAvatar = data.avatars.find(avatar => avatar.name === currentUser.avatar);
                    
                    // If not found with full match, try matching just the filename
                    if (!userCurrentAvatar && currentUser.avatar.includes('/')) {
                        const avatarFilename = currentUser.avatar.split('/').pop();
                        console.log('[v0] Trying to match with filename only:', avatarFilename);
                        userCurrentAvatar = data.avatars.find(avatar => avatar.name === avatarFilename);
                    }
                    
                    if (userCurrentAvatar && userCurrentAvatar.base) {
                        userAvatar = userCurrentAvatar.base;
                        updateAvatarDisplay();
                        console.log('[v0] Avatar displayed successfully:', userCurrentAvatar.name);
                        console.log('[v0] Avatar URL:', userCurrentAvatar.base);
                    } else {
                        console.log('[v0] User avatar not found in available avatars:', currentUser.avatar);
                        console.log('[v0] Available avatars:', data.avatars.map(a => ({ name: a.name, hasBase: !!a.base })));
                        userAvatar = null;
                        // Hide avatar elements if no valid avatar found
                        const userAvatarElement = document.getElementById('userAvatar');
                        const profileAvatarElement = document.getElementById('profileAvatar');
                        if (userAvatarElement) userAvatarElement.style.display = 'none';
                        if (profileAvatarElement) profileAvatarElement.style.display = 'none';
                    }
                } else {
                    console.log('[v0] No avatars available or user has no avatar set');
                    console.log('[v0] Current user avatar:', currentUser?.avatar);
                    console.log('[v0] Avatars count:', data.avatars?.length || 0);
                }
                
                return data.avatars;
            }
            catch (err) {
                console.error('[v0] Error fetching avatars:', err);
                return [];
            }
        }

        function updateAvatarDisplay() {
            const userAvatarElement = document.getElementById('userAvatar');
            const profileAvatarElement = document.getElementById('profileAvatar');
            
            if (userAvatar) {
                if (userAvatarElement) {
                    userAvatarElement.src = userAvatar;
                    console.log('[v0] Updated header avatar display');
                }
                if (profileAvatarElement) {
                    profileAvatarElement.src = userAvatar;
                    console.log('[v0] Updated profile avatar display');
                }
            }
        }

        async function saveUserAvatar(avatarName) {
            if (!userToken || !currentUser) {
                console.error('[v0] No user token or current user data available');
                return false;
            }


            try {
                console.log('[v0] Saving user avatar:', avatarName);
                
                const resp = await fetch(AVATARS_ENDPOINT, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({
                        avatar: avatarName,
                        email: currentUser.email,
                        university: currentUser.university || currentUser.customUniversity
                    })
                });

                if (!resp.ok) {
                    throw new Error(`HTTP error! status: ${resp.status}`);
                }
                
                const result = await resp.json();
                console.log('[v0] User avatar saved successfully:', result);
                return true;
            }
            catch (err) {
                console.error('[v0] Error saving user avatar:', err);
                return false;
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('currentUserData');
                localStorage.removeItem('paymentReference');
                window.location.href = 'sign-in.html';
            }
        }

        const loadingMessages = [
            "Hold on...",
            "Getting things ready...",
            "Almost there...",
            "Just a moment...",
            "Loading your content...",
            "Preparing dashboard...",
            "Finalizing setup..."
        ];
        let currentMessageIndex = 0;
        let messageInterval;
        let countdownInterval;
        
        function showLoading(show = true) {
            const overlay = document.getElementById('loadingOverlay');
            
            if (show) {
                overlay.classList.remove('hidden');
                startLoadingTextCycle();
            } else {
                clearInterval(messageInterval);
                clearInterval(countdownInterval);
                // Hide loading immediately after data is loaded
                updateLoadingText('Dashboard ready!', 'Welcome to your learning experience');
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 500);
            }
        }

        function hideLoading() {
            showLoading(false);
        }

        function startLoadingTextCycle() {
            messageInterval = setInterval(() => {
                currentMessageIndex = (currentMessageIndex + 1) % loadingMessages.length;
                updateLoadingText(loadingMessages[currentMessageIndex], 'Please wait while we set things up');
            }, 1500); // Faster message cycling
        }

        function updateLoadingText(mainText, subText) {
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            
            if (loadingText && loadingSubtext) {
                loadingText.style.opacity = '0';
                loadingSubtext.style.opacity = '0';
                
                setTimeout(() => {
                    loadingText.textContent = mainText;
                    loadingSubtext.textContent = subText;
                    loadingText.style.opacity = '1';
                    loadingSubtext.style.opacity = '1';
                }, 200);
            }
        }




        // Schedule Management API Functions
        async function createOrUpdateSchedule(scheduleData) {
            try {
                console.log('[Schedule API] Creating/updating schedule:', scheduleData);
                
                const response = await fetch(`${API_BASE}/schedules/me`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(scheduleData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('[Schedule API] Schedule created/updated successfully:', result);
                return result;
            } catch (error) {
                console.error('[Schedule API] Error creating/updating schedule:', error);
                console.warn('[Schedule API] Working in offline mode - schedule saved locally');
                
                // Save to localStorage as fallback
                const localSchedules = JSON.parse(localStorage.getItem('offlineSchedules') || '{}');
                localSchedules[scheduleData.courseCode] = { 
                    courseCode: scheduleData.courseCode,
                    days: scheduleData.days,
                    timestamp: new Date().toISOString() 
                };
                localStorage.setItem('offlineSchedules', JSON.stringify(localSchedules));
                
                return { success: true, offline: true };
            }
        }

        async function addSubjectToSchedule(subjectData) {
            try {
                console.log('[Schedule API] Adding subject to schedule:', subjectData);
                
                const response = await fetch(`${API_BASE}/schedules/me/subjects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(subjectData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('[Schedule API] Subject added successfully:', result);
                return result;
            } catch (error) {
                console.error('[Schedule API] Error adding subject to schedule:', error);
                throw error;
            }
        }

        async function removeSubjectFromSchedule(subjectId) {
            try {
                console.log('[Schedule API] Removing subject from schedule:', subjectId);
                
                const response = await fetch(`${API_BASE}/schedules/me/subjects/${subjectId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('[Schedule API] Subject removed successfully:', result);
                return result;
            } catch (error) {
                console.error('[Schedule API] Error removing subject from schedule:', error);
                throw error;
            }
        }

        async function fetchUserSchedule() {
            try {
                console.log('[Schedule API] Fetching user schedule');
                
                const response = await fetch(`${API_BASE}/schedules/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('[Schedule API] Schedule fetched successfully:', result);
                return result;
            } catch (error) {
                console.error('[Schedule API] Error fetching schedule:', error);
                console.warn('[Schedule API] Working in offline mode - loading local schedule');
                
                // Load from localStorage as fallback
                const localSchedules = JSON.parse(localStorage.getItem('offlineSchedules') || '{}');
                const userSchedule = JSON.parse(localStorage.getItem('userSchedule') || '{}');
                
                return { 
                    schedule: userSchedule, 
                    offline: true,
                    message: 'Loaded from local storage (offline mode)'
                };
            }
        }

        // Broken streak management


        // Streak API functions
        async function fetchStreakData() {
            console.log('[v0] === DASHBOARD STREAK FETCH START (API) ===');
            console.log('[v0] userToken:', userToken ? 'Present' : 'Missing');
            
            if (!userToken) {
                console.log('[v0] ❌ No userToken available, cannot fetch streak data');
                currentStreak = 0;
                maxStreak = 0;
                streakData = [];
                updateStreakDisplay();
                return;
            }

            try {
                console.log('[v0] 🔄 Fetching streak data from API endpoint:', STREAK_BASE_URL);
                
                const response = await fetch(STREAK_BASE_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                console.log('[v0] 📡 Streak API response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                const apiResponse = await response.json();
                console.log('[v0] ✅ Full API response:', apiResponse);
                
                // Extract streak data from the correct response structure
                const streakResult = apiResponse.result || {};
                currentStreak = streakResult.streakCount || 0;
                maxStreak = streakResult.maxStreakCount || 0;
                const lastQuizStartDate = streakResult.lastQuizStartDate;
                
                console.log('[v0] ✅ Current streak from API:', currentStreak);
                console.log('[v0] ✅ Max streak from API:', maxStreak);
                console.log('[v0] ✅ Last quiz date from API:', lastQuizStartDate);
                
                // Check if last quiz date is today
                const todayString = new Date().toISOString().split('T')[0];
                const lastQuizString = lastQuizStartDate ? new Date(lastQuizStartDate).toISOString().split('T')[0] : null;
                console.log('[v0] 🔍 Today string:', todayString);
                console.log('[v0] 🔍 Last quiz string:', lastQuizString);
                console.log('[v0] 🔍 Is last quiz today?', lastQuizString === todayString);
                
                // Create streak data for calendar display
                streakData = [];
                
                // Check if today should be included in the streak
                const todayStringCheck = new Date().toISOString().split('T')[0];
                const lastQuizStringCheck = lastQuizStartDate ? new Date(lastQuizStartDate).toISOString().split('T')[0] : null;
                const shouldIncludeToday = currentStreak > 0 && lastQuizStringCheck === todayStringCheck;
                
                console.log('[v0] 🎯 Should include today in streak?', shouldIncludeToday);
                console.log('[v0] 🎯 Current streak:', currentStreak);
                console.log('[v0] 🎯 Last quiz date string:', lastQuizStringCheck);
                console.log('[v0] 🎯 Today string:', todayStringCheck);
                
                if (lastQuizStartDate && currentStreak > 0) {
                    // Add all consecutive streak days leading up to the last quiz date
                    const lastQuizDate = new Date(lastQuizStartDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Reset time to start of day for accurate comparison
                    
                    // Safety check: if lastQuizDate is in the future, set it to today
                    if (lastQuizDate > today) {
                        console.log('[v0] ⚠️ WARNING: lastQuizDate is in the future, adjusting to today');
                        console.log('[v0] ⚠️ Original lastQuizDate:', lastQuizDate.toDateString());
                        lastQuizDate.setTime(today.getTime());
                        console.log('[v0] ⚠️ Adjusted lastQuizDate:', lastQuizDate.toDateString());
                    }
                    
                    console.log('[v0] 📅 Last quiz date:', lastQuizDate.toDateString());
                    console.log('[v0] 📅 Today:', today.toDateString());
                    
                    for (let i = 0; i < currentStreak; i++) {
                        const streakDate = new Date(lastQuizDate);
                        streakDate.setDate(lastQuizDate.getDate() - i);
                        streakDate.setHours(0, 0, 0, 0); // Reset time for accurate comparison
                        
                        console.log('[v0] 🔍 Checking streak date:', streakDate.toDateString(), 'vs today:', today.toDateString());
                        console.log('[v0] 🔍 Date comparison: streakDate <=', streakDate.getTime(), 'today <=', today.getTime(), '=', streakDate <= today);
                        
                        // Only add dates that are not in the future
                        if (streakDate <= today) {
                            const dateString = streakDate.toISOString().split('T')[0];
                            // Determine if this is part of a complete streak (7+ days) or incomplete
                            const isCompleteStreak = currentStreak >= 7;
                            streakData.push({
                                date: dateString,
                                completed: true,
                                isCompleteStreak: isCompleteStreak
                            });
                            console.log('[v0] 📅 Added streak date:', dateString, '(', streakDate.toDateString(), ')');
                        } else {
                            console.log('[v0] 📅 Skipped future date:', streakDate.toDateString());
                        }
                    }
                }
                
                console.log('[v0] 📅 Generated streak data:', streakData);
                
                // Update localStorage as backup
                localStorage.setItem('userStreak', currentStreak.toString());
                localStorage.setItem('maxStreak', maxStreak.toString());
                if (lastQuizStartDate) {
                    localStorage.setItem('lastQuizDate', lastQuizStartDate);
                }
                
                console.log('[v0] 📅 Generated streak data:', streakData);
                

                
                updateStreakDisplay();
                generateStreakCalendar();
                updateWeeklyCalendar();
                
                console.log('[v0] ✅ Dashboard UI updated with streak data from API');
                
            } catch (error) {
                console.error('[v0] ❌ Error fetching streak data from API:', error);
                console.error('[v0] Error details:', error.message);
                
                // Fallback to localStorage if API fails
                console.log('[v0] 🔄 Falling back to localStorage data');
                console.log('[v0] 🔍 All localStorage keys:', Object.keys(localStorage));
                console.log('[v0] 🔍 localStorage userStreak:', localStorage.getItem('userStreak'));
                console.log('[v0] 🔍 localStorage maxStreak:', localStorage.getItem('maxStreak'));
                console.log('[v0] 🔍 localStorage lastQuizDate:', localStorage.getItem('lastQuizDate'));
                
                currentStreak = parseInt(localStorage.getItem('userStreak') || '0');
                maxStreak = parseInt(localStorage.getItem('maxStreak') || '0');
                const lastQuizDate = localStorage.getItem('lastQuizDate');
                
                console.log('[v0] 📊 Parsed fallback data - Current streak:', currentStreak, 'Max streak:', maxStreak, 'Last quiz date:', lastQuizDate);
                

                
                streakData = [];
                
                // Check if today should be included in the streak (fallback)
                const todayStringCheckFallback = new Date().toISOString().split('T')[0];
                const lastQuizStringCheckFallback = lastQuizDate ? new Date(lastQuizDate).toISOString().split('T')[0] : null;
                const shouldIncludeTodayFallback = currentStreak > 0 && lastQuizStringCheckFallback === todayStringCheckFallback;
                
                console.log('[v0] 🎯 [FALLBACK] Should include today in streak?', shouldIncludeTodayFallback);
                console.log('[v0] 🎯 [FALLBACK] Current streak:', currentStreak);
                console.log('[v0] 🎯 [FALLBACK] Last quiz date string:', lastQuizStringCheckFallback);
                console.log('[v0] 🎯 [FALLBACK] Today string:', todayStringCheckFallback);
                
                // Be more conservative with fallback data - only show streaks if lastQuizDate is recent
                if (lastQuizDate && currentStreak > 0) {
                    const lastQuizDateObj = new Date(lastQuizDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    lastQuizDateObj.setHours(0, 0, 0, 0);
                    
                    // Calculate days since last quiz
                    const daysSinceLastQuiz = Math.floor((today - lastQuizDateObj) / (1000 * 60 * 60 * 24));
                    
                    console.log('[v0] 📅 [FALLBACK] Last quiz date:', lastQuizDateObj.toDateString());
                    console.log('[v0] 📅 [FALLBACK] Today:', today.toDateString());
                    console.log('[v0] 📅 [FALLBACK] Days since last quiz:', daysSinceLastQuiz);
                    
                    // Only show streak data if the last quiz was within the last 2 days
                    // This prevents showing stale streak data from weeks ago
                    if (daysSinceLastQuiz <= 1) {
                        console.log('[v0] ✅ [FALLBACK] Last quiz is recent, generating full streak data');
                        
                        // Generate the full streak data like the API would
                        for (let i = 0; i < currentStreak; i++) {
                            const streakDate = new Date(lastQuizDateObj);
                            streakDate.setDate(lastQuizDateObj.getDate() - i);
                            streakDate.setHours(0, 0, 0, 0);
                            
                            // Only add dates that are not in the future
                            if (streakDate <= today) {
                                const dateString = streakDate.toISOString().split('T')[0];
                                const isCompleteStreak = currentStreak >= 7;
                                streakData.push({
                                    date: dateString,
                                    completed: true,
                                    isCompleteStreak: isCompleteStreak
                                });
                                console.log('[v0] 📅 [FALLBACK] Added streak date:', dateString, '(', streakDate.toDateString(), ')');
                            } else {
                                console.log('[v0] 📅 [FALLBACK] Skipped future date:', streakDate.toDateString());
                            }
                        }
                    } else {
                        console.log('[v0] ⚠️ [FALLBACK] Last quiz is too old (' + daysSinceLastQuiz + ' days ago), not showing streak data');
                        // Reset streak values since the data is stale
                        currentStreak = 0;
                        localStorage.setItem('userStreak', '0');
                        console.log('[v0] ⚠️ [FALLBACK] Reset currentStreak to 0 due to stale data');
                    }
                } else {
                    console.log('[v0] ⚠️ [FALLBACK] No valid lastQuizDate or currentStreak, not generating streak data');
                    localStorage.setItem('userStreak', '0');
                }
                


                
                updateStreakDisplay();
                generateStreakCalendar();
                updateWeeklyCalendar();
            }
            
            console.log('[v0] === DASHBOARD STREAK FETCH END ===');
        }

        window.addEventListener('streakUpdated', function(event) {
            console.log('[v0] 🔄 === STREAK UPDATE EVENT RECEIVED ===');
            console.log('[v0] 🔄 Event detail:', event.detail);
            console.log('[v0] 🔄 Event timestamp:', new Date().toISOString());
            console.log('[v0] 🔄 Current userToken status:', userToken ? 'Available' : 'Missing');
            console.log('[v0] 🔄 Refreshing streak data from API...');
            
            // Fetch fresh data from API instead of using potentially stale event data
            fetchStreakData();
            updateStreakDisplay();
            generateStreakCalendar();
            updateWeeklyCalendar();
            
            console.log('[v0] 🔄 === STREAK UPDATE EVENT HANDLED ===');
        });

        function updateStreakDisplay() {
            const streakNumber = document.getElementById('streakNumber');
            const streakText = document.getElementById('streakText');
            const firstName = userName.split(' ')[0];
            
            console.log('[v0] Updating streak display with current:', currentStreak, 'max:', maxStreak);
            
            if (streakNumber) {
                streakNumber.textContent = currentStreak;
            }
            
            if (streakText) {
                if (currentStreak === 0) {
                    if (maxStreak > 0) {
                        streakText.textContent = `Your best streak was ${maxStreak} days. Start a new one today! 🔥`;
                    } else {
                        streakText.textContent = "Start your learning streak today! 🔥";
                    }
                } else {
                    // Dynamic messages based on streak count
                    let message = "";
                    
                    // Check if it's a multiple of 7 (weekly milestone)
                    const isWeeklyMilestone = currentStreak % 7 === 6; // 6, 13, 20, etc (one day before completing a week)
                    const isWeekComplete = currentStreak % 7 === 0 && currentStreak > 0; // 7, 14, 21, etc
                    
                    if (isWeeklyMilestone) {
                        message = `${currentStreak} days! One more day to complete the week ${firstName}! 🗓️✨`;
                    } else if (isWeekComplete) {
                        const weeks = currentStreak / 7;
                        message = `${currentStreak} days! ${weeks} week${weeks > 1 ? 's' : ''} completed! You're unstoppable ${firstName}! 🏆🔥`;
                    } else {
                        switch (currentStreak) {
                            case 1:
                                message = `Great start! The first steps are the best ${firstName} 🌟`;
                                break;
                            case 2:
                                message = `Two in a row! You're building momentum ${firstName} 🚀`;
                                break;
                            case 3:
                                message = `3 in a row! The habit is forming beautifully ${firstName} 💎`;
                                break;
                            case 4:
                                message = `4 days strong! You're on fire ${firstName} 🔥`;
                                break;
                            case 5:
                                message = `High five! 5 days of pure dedication! You're basically a learning ninja now ${firstName} 🥷✨`;
                                break;
                            default:
                                if (currentStreak === maxStreak && maxStreak > 5) {
                                    message = `${currentStreak} Days - New personal record! You're absolutely crushing it ${firstName}! 🏆🎉`;
                                } else if (currentStreak > 10) {
                                    message = `${currentStreak} days! You're a learning legend ${firstName}! Keep the fire burning 🔥🏆`;
                                } else {
                                    message = `${currentStreak} days in a row! Your dedication is inspiring ${firstName} 💪✨`;
                                }
                                break;
                        }
                    }
                    
                    streakText.textContent = message;
                }
            }
        }

        // Handle course click - now uses the quiz endpoint
        function handleCourseClick(courseId, courseCode) {
            
            // Show feedback
            const courseCard = document.querySelector(`[data-course="${courseCode}"]`);
            courseCard.style.transform = 'scale(0.95)';
            setTimeout(() => {
                courseCard.style.transform = 'scale(1)';
                // Navigate to quiz using the provided endpoint
                const quizUrl = `${API_BASE}/quiz/course/${courseId}`;
                console.log(`[v0] Navigating to quiz for course ${courseCode} with ID ${courseId}`);
                console.log(`[v0] Quiz endpoint: ${quizUrl}`);
                // For now, just log the endpoint - you can implement actual navigation
                window.location.href = `quiz.html?courseId=${courseId}&courseCode=${courseCode}`;
            }, 150);
        }

        // Initialize next available day based on current day
        function initializeScheduleDay() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Convert to Monday = 0, Tuesday = 1, etc.
            nextAvailableDay = dayOfWeek === 0 ? 0 : dayOfWeek - 1;
        }

        function generateCalendar() {
            console.log('[v0] 📅 === WEEKLY CALENDAR GENERATION START ===');
            const calendar = document.getElementById('calendar');
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day
            const currentDay = today.getDay();
            const todayDateString = today.toISOString().split('T')[0];
            
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const tomorrowDay = (currentDay + 1) % 7;
            
            console.log('[v0] 📅 Current streakData:', streakData);
            console.log('[v0] 📅 Today:', today.toDateString(), 'Current day of week:', currentDay, '(' + dayNames[currentDay] + ')');
            console.log('[v0] 📅 Tomorrow will be day:', tomorrowDay, '(' + dayNames[tomorrowDay] + ')');
            console.log('[v0] 📅 Today date string:', todayDateString);
            console.log('[v0] 📅 Looking for today in streakData:', streakData.find(s => s.date === todayDateString));
            

            

            
            calendar.innerHTML = '';
            
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            
            for (let i = 0; i < 7; i++) {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                
                const dayDate = new Date(today);
                dayDate.setDate(today.getDate() - currentDay + i);
                dayDate.setHours(0, 0, 0, 0); // Normalize to start of day
                
                const dateString = dayDate.toISOString().split('T')[0];
                const streakInfo = streakData.find(streak => streak.date === dateString && streak.completed);
                const hasStreak = !!streakInfo;
                
                console.log('[v0] 📅 Day', i, ':', days[i], 'Date:', dayDate.toDateString(), 'DateString:', dateString, 'HasStreak:', hasStreak);
                console.log('[v0] 📅 Current day index:', currentDay);
                console.log('[v0] 📅 Calculation: today.getDate()=' + today.getDate() + ' - currentDay=' + currentDay + ' + i=' + i + ' = ' + (today.getDate() - currentDay + i));
                if (streakInfo) {
                    console.log('[v0] 📅 Found streak info for', dateString, ':', streakInfo);
                }
                
                if (i === currentDay) {
                    dayCard.classList.add('current');
                    console.log('[v0] 📅 Added "current" class to day', i);
                    
                    // CURRENT DAY LOGIC: Add completed class if this day has a completed streak
                    if (hasStreak) {
                        dayCard.classList.add('completed');
                        console.log('[v0] 🎯 CURRENT DAY COMPLETED: Added "completed" class to current day');
                    } else {
                        console.log('[v0] 🎯 CURRENT DAY NOT COMPLETED: No streak data for current day');
                    }
                } else if (hasStreak) {
                    dayCard.classList.add('completed');
                    console.log('[v0] 📅 Added "completed" class to day', i);
                }
                
                // Current day debugging
                if (i === currentDay) {
                    console.log('[v0] 🔍 CURRENT DAY DEBUG - Day:', i, '(', days[i], ')');
                    console.log('[v0] 🔍 Has streak in data?:', hasStreak);
                    console.log('[v0] 🔍 Should current day circle be orange?:', hasStreak);
                }
                

                
                dayCard.innerHTML = `
                    <div class="day-name">${days[i]}</div>
                    <div class="day-date-circle">
                        <span class="date-number">${dayDate.getDate()}</span>
                    </div>
                `;
                

                
                calendar.appendChild(dayCard);
                

            }
            
            console.log('[v0] 📅 === WEEKLY CALENDAR GENERATION END ===');
        }

        function updateWeeklyCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            generateCalendar();
        }

        function generateStreakCalendar() {
            const calendar = document.getElementById('streakCalendar');
            const monthTitle = document.getElementById('monthTitle');
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const daysHeader = document.getElementById('calendarDaysHeader');
            
            // Set month title
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            monthTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Clear calendar
            calendar.innerHTML = '';
            daysHeader.innerHTML = '';
            
            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Create days header
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            for (let i = 0; i < 7; i++) {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = dayNames[i];
                daysHeader.appendChild(dayHeader);
            }
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendar.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                const dayDate = new Date(currentYear, currentMonth, day);
                dayDate.setHours(0, 0, 0, 0); // Normalize to start of day
                const dateString = dayDate.toISOString().split('T')[0];
                const streakInfo = streakData.find(streak => streak.date === dateString && streak.completed);
                
                if (dayDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('current');
                }
                
                if (streakInfo) {
                    dayElement.classList.add('completed');
                    console.log('[v0] 🟠 Completed streak day:', dateString);
                } else if (dayDate > today) {
                    dayElement.classList.add('future');
                } else if (dayDate < today) {
                    dayElement.classList.add('past');
                }
                
                calendar.appendChild(dayElement);
            }
            
            // Add empty cells to complete the last row if needed
            const totalCells = calendar.children.length;
            const remainingCells = 7 - (totalCells % 7);
            if (remainingCells < 7) {
                for (let i = 0; i < remainingCells; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day empty';
                    calendar.appendChild(emptyDay);
                }
            }
        }

        // Setup course scheduling with new logic
        function setupCourseScheduling() {
            const scheduleCards = document.querySelectorAll('.schedule-course');
            const setBtn = document.getElementById('scheduleSetBtn');
            
            scheduleCards.forEach(card => {
                const courseCode = card.getAttribute('data-course');
                const plusBtn = card.querySelector('.schedule-plus-btn');
                const minusBtn = card.querySelector('.schedule-minus-btn');
                
                if (plusBtn) {
                    plusBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (isScheduleLocked) return;
                        addCourseToSchedule(courseCode);
                    });
                }
                
                if (minusBtn) {
                    minusBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (isScheduleLocked) return;
                        removeCourseFromSchedule(courseCode);
                    });
                }
                
                // Initialize display
                updateCourseDisplay(courseCode, card);
            });
            
            if (setBtn) {
                setBtn.addEventListener('click', () => {
                    if (setBtn.classList.contains('active') && !isScheduleLocked) {
                        setSchedule();
                    }
                });
            }
            
            updateSetButton();
        }

        function addCourseToSchedule(courseCode) {
            if (!courseSchedule[courseCode]) {
                const nextDay = recalculateNextAvailableDay();
                if (nextDay !== null) {
                    courseSchedule[courseCode] = nextDay;
                    updateAllCourseDisplays();
                }
            }
        }

        function removeCourseFromSchedule(courseCode) {
            if (courseSchedule[courseCode] !== undefined) {
                delete courseSchedule[courseCode];
                updateAllCourseDisplays();
            }
        }

        function recalculateNextAvailableDay() {
            const today = new Date();
            const currentDay = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Convert to our format where Monday = 0
            const currentDayIndex = currentDay === 0 ? 6 : currentDay - 1;
            
            const scheduledDays = Object.values(courseSchedule);
            
            // Find the next available day starting from current day
            for (let i = 0; i < 7; i++) {
                const dayToCheck = (currentDayIndex + i) % 7;
                if (!scheduledDays.includes(dayToCheck)) {
                    return dayToCheck;
                }
            }
            
            return null; // All days are taken
        }

        function updateAllCourseDisplays() {
            const scheduleCards = document.querySelectorAll('.schedule-course');
            
            scheduleCards.forEach(card => {
                const courseCode = card.getAttribute('data-course');
                updateCourseDisplay(courseCode, card);
            });
            
            updateSetButton();
        }

        function updateCourseDisplay(courseCode, card) {
            const dayElement = card.querySelector('.schedule-course-day');
            const plusBtn = card.querySelector('.schedule-plus-btn');
            const minusBtn = card.querySelector('.schedule-minus-btn');
            
            if (courseSchedule[courseCode] !== undefined) {
                const dayIndex = courseSchedule[courseCode];
                const dayName = dayAbbreviations[dayIndex];
                dayElement.textContent = dayName;
                dayElement.style.color = '#007bff';
                
                if (plusBtn) plusBtn.disabled = true;
                if (minusBtn) minusBtn.disabled = false;
            } else {
                dayElement.textContent = '';
                
                if (plusBtn) plusBtn.disabled = false;
                if (minusBtn) minusBtn.disabled = true;
            }
        }

        function updateSetButton() {
            const setBtn = document.getElementById('scheduleSetBtn');
            const hasSelections = Object.keys(courseSchedule).length > 0;
            
            if (hasSelections) {
                setBtn.classList.add('active');
            } else {
                setBtn.classList.remove('active');
            }
        }

        async function setSchedule() {
            try {
                showLoading('Saving your schedule...');
                
                let isOfflineMode = false;
                
                // Save schedule to backend using the new API
                for (const [courseCode, dayIndex] of Object.entries(courseSchedule)) {
                    // Create or update schedule for each course
                    const scheduleData = {
                        courseCode: courseCode,
                        days: [dayIndex],
                        userId: userToken // or however the API identifies users
                    };
                    
                    const result = await createOrUpdateSchedule(scheduleData);
                    if (result && result.offline) {
                        isOfflineMode = true;
                    }
                    
                    // Add subject to schedule (skip if offline)
                    if (!isOfflineMode) {
                        const subjectData = {
                            courseCode: courseCode,
                            dayIndex: dayIndex,
                            scheduledDate: new Date().toISOString()
                        };
                        await addSubjectToSchedule(subjectData);
                    }
                }
                
                // Save to localStorage regardless of online/offline status
                localStorage.setItem('userSchedule', JSON.stringify(courseSchedule));
                
                // Mark schedule as locked
                isScheduleLocked = true;
                scheduledCourses = { ...courseSchedule };
                
                // Hide schedule content and show locked message
                document.getElementById('scheduleContent').style.display = 'none';
                document.getElementById('scheduleLocked').style.display = 'block';
                
                // Update course cards on home page
                updateHomeCourseCards();
                
                // Lock all course elements
                const courses = document.querySelectorAll('.schedule-course');
                courses.forEach(course => {
                    course.classList.add('locked');
                });
                
                hideLoading();
                
                if (isOfflineMode) {
                    showAlert('Schedule saved locally! Working in offline mode - your schedule will sync when connection is restored.', 'warning');
                } else {
                    showAlert('Schedule saved successfully! Your study plan is now active.', 'success');
                }
                
            } catch (error) {
                console.error('Error saving schedule:', error);
                hideLoading();
                
                // Save to localStorage as fallback
                localStorage.setItem('userSchedule', JSON.stringify(courseSchedule));
                showAlert('Connection failed - schedule saved locally. Your schedule will sync when connection is restored.', 'warning');
            }
        }

        async function loadUserSchedule() {
            try {
                const schedule = await fetchUserSchedule();
                
                if (schedule && schedule.offline) {
                    // Load from localStorage in offline mode
                    const localSchedule = JSON.parse(localStorage.getItem('userSchedule') || '{}');
                    courseSchedule = localSchedule;
                    scheduledCourses = { ...localSchedule };
                    console.log('[Schedule] Loaded from localStorage (offline mode)');
                } else if (schedule && schedule.courses) {
                    // Convert API response to our internal format
                    courseSchedule = {};
                    scheduledCourses = {};
                    
                    schedule.courses.forEach(course => {
                        if (course.days && course.days.length > 0) {
                            // Take the first day if multiple days are returned
                            courseSchedule[course.courseCode] = course.days[0];
                            scheduledCourses[course.courseCode] = course.days[0];
                        }
                    });
                    
                    // Save to localStorage for offline access
                    localStorage.setItem('userSchedule', JSON.stringify(courseSchedule));
                }
                
                // Check if schedule is locked (e.g., if it's not Sunday)
                const today = new Date();
                const dayOfWeek = today.getDay();
                if (dayOfWeek !== 0 && Object.keys(scheduledCourses).length > 0) {
                    isScheduleLocked = true;
                    document.getElementById('scheduleContent').style.display = 'none';
                    document.getElementById('scheduleLocked').style.display = 'block';
                }
                
                // Update displays
                updateHomeCourseCards();
                
                // Update schedule interface if not locked
                if (!isScheduleLocked) {
                    const scheduleCards = document.querySelectorAll('.schedule-course');
                    scheduleCards.forEach(card => {
                        const courseCode = card.getAttribute('data-course');
                        updateCourseDisplay(courseCode, card);
                    });
                    updateSetButton();
                }
                
            } catch (error) {
                console.error('Error loading user schedule:', error);
                
                // Fallback to localStorage
                try {
                    const localSchedule = JSON.parse(localStorage.getItem('userSchedule') || '{}');
                    courseSchedule = localSchedule;
                    scheduledCourses = { ...localSchedule };
                    console.log('[Schedule] Loaded from localStorage (fallback)');
                    
                    // Update displays with local data
                    updateHomeCourseCards();
                    
                    if (!isScheduleLocked) {
                        const scheduleCards = document.querySelectorAll('.schedule-course');
                        scheduleCards.forEach(card => {
                            const courseCode = card.getAttribute('data-course');
                            updateCourseDisplay(courseCode, card);
                        });
                        updateSetButton();
                    }
                } catch (localError) {
                    console.error('Error loading from localStorage:', localError);
                    // Continue with empty schedule if everything fails
                }
            }
        }

        function updateHomeCourseCards() {
            const courseCards = document.querySelectorAll('.course-card');
            
            courseCards.forEach(card => {
                const courseCode = card.dataset.course;
                const indicator = card.querySelector('.course-schedule-indicator');
                
                if (scheduledCourses[courseCode] !== undefined) {
                    const dayIndex = scheduledCourses[courseCode];
                    const dayName = dayAbbreviations[dayIndex];
                    indicator.textContent = dayName;
                    card.classList.add('scheduled');
                } else {
                    indicator.textContent = '';
                    card.classList.remove('scheduled');
                }
            });
        }

        // Dark mode functionality
        function setupDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                darkModeToggle.classList.add('active');
            }
            
            darkModeToggle.addEventListener('click', () => {
                const isDark = body.getAttribute('data-theme') === 'dark';
                
                if (isDark) {
                    body.removeAttribute('data-theme');
                    darkModeToggle.classList.remove('active');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.setAttribute('data-theme', 'dark');
                    darkModeToggle.classList.add('active');
                    localStorage.setItem('theme', 'dark');
                }
            });
        }

        // Update calendar scroll indicator
        function updateCalendarScrollIndicator() {
            const container = document.getElementById('calendarContainer');
            const thumb = document.getElementById('scrollThumb');
            const scrollPercentage = container.scrollLeft / (container.scrollWidth - container.clientWidth);
            const maxLeft = 70;
            thumb.style.left = `${scrollPercentage * maxLeft}%`;
        }

        // Trigger streak animations
        function triggerStreakAnimations() {
            if (!streakAnimationsTriggered) {
                const streaksPage = document.getElementById('streaksPage');
                streaksPage.classList.add('streak-animations-active');
                streakAnimationsTriggered = true;
            }
        }

        // Navigation functionality
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const navSlider = document.getElementById('navSlider');
            
            navItems.forEach((item, index) => {
                item.addEventListener('click', () => {
                    navigateToPage(index);
                });
            });
        }

        function navigateToPage(pageIndex) {
            currentPage = pageIndex;
            const mainContainer = document.getElementById('mainContainer');
            const navItems = document.querySelectorAll('.nav-item');
            const navSlider = document.getElementById('navSlider');
            
            mainContainer.style.transform = `translateX(-${pageIndex * 25}%)`;
            navSlider.style.left = `${pageIndex * 25}%`;
            
            navItems.forEach(nav => nav.classList.remove('active'));
            navItems[pageIndex].classList.add('active');
            
            // Load videos when navigating to videos page
            if (pageIndex === 1 && !document.querySelector('.video-card')) {
                loadVideos();
            }
            
            // Trigger streak animations when navigating to streaks page
            if (pageIndex === 2) {
                setTimeout(triggerStreakAnimations, 100);
            }
        }

        // Touch/swipe functionality with direction detection
        function setupSwipeNavigation() {
            const viewport = document.querySelector('.viewport');
            
            viewport.addEventListener('touchstart', handleTouchStart, { passive: true });
            viewport.addEventListener('touchmove', handleTouchMove, { passive: false });
            viewport.addEventListener('touchend', handleTouchEnd, { passive: true });
        }

        function handleTouchStart(e) {
            if (e.target.closest('.calendar-container')) {
                return;
            }
            
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            isDragging = true;
            isVerticalScroll = false;
            isHorizontalSwipe = false;
        }

        function handleTouchMove(e) {
            if (!isDragging || !startX || !startY) return;
            
            if (e.target.closest('.calendar-container')) {
                return;
            }
            
            const currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const diffX = Math.abs(startX - currentX);
            const diffY = Math.abs(startY - currentY);
            
            if (!isVerticalScroll && !isHorizontalSwipe) {
                if (diffY > diffX && diffY > 10) {
                    isVerticalScroll = true;
                } else if (diffX > diffY && diffX > 10) {
                    isHorizontalSwipe = true;
                    e.preventDefault();
                }
            }
            
            if (isHorizontalSwipe && diffX > 20) {
                e.preventDefault();
                const mainContainer = document.getElementById('mainContainer');
                const currentTransform = -currentPage * 25;
                const dragPercentage = ((startX - currentX) / window.innerWidth) * 25;
                mainContainer.style.transform = `translateX(${currentTransform - dragPercentage}%)`;
            }
        }

        function handleTouchEnd(e) {
            if (!isDragging || !startX) return;
            
            if (e.target.closest('.calendar-container')) {
                isDragging = false;
                startX = null;
                startY = null;
                return;
            }
            
            if (isHorizontalSwipe) {
                const endX = e.changedTouches[0].clientX;
                const diffX = startX - endX;
                
                if (Math.abs(diffX) > 80) {
                    if (diffX > 0 && currentPage < totalPages - 1) {
                        navigateToPage(currentPage + 1);
                    } else if (diffX < 0 && currentPage > 0) {
                        navigateToPage(currentPage - 1);
                    } else {
                        navigateToPage(currentPage);
                    }
                } else {
                    navigateToPage(currentPage);
                }
            }
            
            isDragging = false;
            startX = null;
            startY = null;
            isVerticalScroll = false;
            isHorizontalSwipe = false;
        }

        // Calendar scroll handling
        function setupCalendarScroll() {
            const container = document.getElementById('calendarContainer');
            container.addEventListener('scroll', updateCalendarScrollIndicator);
        }

        // Load videos
        function loadVideos() {
            Object.entries(sections).forEach(([subject, videos]) => {
                const container = document.getElementById(`grid-${subject}`);
                if (!container.hasChildNodes()) {
                    videos.forEach((video, index) => {
                        const videoCard = document.createElement('div');
                        videoCard.className = 'video-card';
                        videoCard.onclick = () => openVideoPlayer(video.videoId, video.title);
                
                        videoCard.innerHTML = `
                            <div class="video-thumbnail">
                                <img src="https://img.youtube.com/vi/${video.videoId}/maxresdefault.jpg" alt="${video.title}">
                                <div class="play-button">
                                    <svg fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </div>
                                <div class="video-duration">${video.duration}</div>
                            </div>
                            <div class="video-info">
                                <div class="video-title">${video.title}</div>
                            </div>
                        `;
                
                        container.appendChild(videoCard);
                    });
                }
            });
        }

        function createVideoCard(video) {
            const videoCard = document.createElement('div');
            videoCard.className = 'video-card';
            videoCard.onclick = () => openVideoPlayer(video.videoId, video.title);
            
            videoCard.innerHTML = `
                <div class="video-thumbnail">
                    <img src="https://img.youtube.com/vi/${video.videoId}/maxresdefault.jpg" alt="${video.title}">
                    <div class="play-button">
                        <svg fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </div>
                <div class="video-duration">${video.duration}</div>
            </div>
            <div class="video-info">
                <div class="video-title">${video.title}</div>
            </div>
        `;
            
            return videoCard;
        }

        function openVideoPlayer(videoId, title) {
            const overlay = document.getElementById('videoPlayerOverlay');
            const playerTitle = document.getElementById('videoPlayerTitle');
            const iframeContainer = document.getElementById('videoIframeContainer');
            
            playerTitle.textContent = title;
            iframeContainer.innerHTML = `
                <iframe 
                    src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" 
                    frameborder="0" 
                    allowfullscreen
                    allow="autoplay; encrypted-media">
                </iframe>
            `;
            
            overlay.classList.add('active');
        }

        function closeVideoPlayer() {
            const overlay = document.getElementById('videoPlayerOverlay');
            const iframeContainer = document.getElementById('videoIframeContainer');
            
            overlay.classList.remove('active');
            
            setTimeout(() => {
                iframeContainer.innerHTML = '';
            }, 400);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Show loading overlay
                showLoading(true);
                
                // Check authentication first
                const isAuthenticated = await checkAuthStatus();
                if (!isAuthenticated) {
                    showLoading(false);
                    return;
                }
                
                updateLoadingText('Loading your courses...', 'Fetching semester content');
                
                // Fetch courses from API
                await fetchCourses();
                
                updateLoadingText('Loading your avatar...', 'Fetching user avatar');
                await fetchAvatars();
                
                // Fetch streak data
                updateLoadingText('Loading your progress...', 'Getting streak information');
                await fetchStreakData();
                
                // Initialize all components
                updateLoadingText('Setting up dashboard...', 'Preparing interface');
                setupNavigation();
                setupSwipeNavigation();
                setupCalendarScroll();
                setupDarkMode();
                updateCalendarScrollIndicator();
                
                // Load user schedule
                updateLoadingText('Loading your schedule...', 'Getting study plan');
                await loadUserSchedule();
                
                document.getElementById('videoPlayerOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'videoPlayerOverlay') {
                        closeVideoPlayer();
                    }
                });
                
                // Hide loading overlay after initialization
                showLoading(false);
            } catch (error) {
                console.error('[v0] Dashboard initialization error:', error);
                updateLoadingText('Initialization failed', 'Please refresh the page');
                showLoading(false);
            }
        });
    </script>
</body>
</html>